var BiwaScheme=BiwaScheme||{};BiwaScheme.Version="0.6.2.dev";BiwaScheme.GitCommit="6645c10157e7b5772cef433e97918aa8351785ac";
(function(){function a(c,d,e){if(c===d)return c!==0||1/c==1/d;if(c==null||d==null)return c===d;if(c._chain)c=c._wrapped;if(d._chain)d=d._wrapped;if(j.isFunction(c.isEqual))return c.isEqual(d);if(j.isFunction(d.isEqual))return d.isEqual(c);var f=o.call(c);if(f!=o.call(d))return false;switch(f){case "[object String]":return String(c)==String(d);case "[object Number]":return c=+c,d=+d,c!=c?d!=d:c==0?1/c==1/d:c==d;case "[object Date]":case "[object Boolean]":return+c==+d;case "[object RegExp]":return c.source==
d.source&&c.global==d.global&&c.multiline==d.multiline&&c.ignoreCase==d.ignoreCase}if(typeof c!="object"||typeof d!="object")return false;for(var h=e.length;h--;)if(e[h]==c)return true;e.push(c);var h=0,g=true;if(f=="[object Array]"){if(h=c.length,g=h==d.length)for(;h--;)if(!(g=h in c==h in d&&a(c[h],d[h],e)))break}else{if("constructor"in c!="constructor"in d||c.constructor!=d.constructor)return false;for(var k in c)if(t.call(c,k)&&(h++,!(g=t.call(d,k)&&a(c[k],d[k],e))))break;if(g){for(k in d)if(t.call(d,
k)&&!h--)break;g=!h}}e.pop();return g}var c=this,d=c._,e={},f=Array.prototype,g=Object.prototype,h=f.slice,k=f.unshift,o=g.toString,t=g.hasOwnProperty,y=f.forEach,u=f.map,l=f.reduce,r=f.reduceRight,s=f.filter,p=f.every,m=f.some,w=f.indexOf,B=f.lastIndexOf,g=Array.isArray,E=Object.keys,z=Function.prototype.bind,j=function(a){return new x(a)};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports)exports=module.exports=j;exports._=j}else typeof define==="function"&&define.amd?
define("underscore",function(){return j}):c._=j;j.VERSION="1.2.2";var q=j.each=j.forEach=function(a,c,d){if(a!=null)if(y&&a.forEach===y)a.forEach(c,d);else if(a.length===+a.length)for(var f=0,h=a.length;f<h;f++){if(f in a&&c.call(d,a[f],f,a)===e)break}else for(f in a)if(t.call(a,f)&&c.call(d,a[f],f,a)===e)break};j.map=function(a,c,d){var e=[];if(a==null)return e;if(u&&a.map===u)return a.map(c,d);q(a,function(a,f,h){e[e.length]=c.call(d,a,f,h)});return e};j.reduce=j.foldl=j.inject=function(a,c,d,e){var f=
d!==void 0;a==null&&(a=[]);if(l&&a.reduce===l)return e&&(c=j.bind(c,e)),f?a.reduce(c,d):a.reduce(c);q(a,function(a,h,g){f?d=c.call(e,d,a,h,g):(d=a,f=true)});if(!f)throw new TypeError("Reduce of empty array with no initial value");return d};j.reduceRight=j.foldr=function(a,c,d,e){a==null&&(a=[]);if(r&&a.reduceRight===r)return e&&(c=j.bind(c,e)),d!==void 0?a.reduceRight(c,d):a.reduceRight(c);a=(j.isArray(a)?a.slice():j.toArray(a)).reverse();return j.reduce(a,c,d,e)};j.find=j.detect=function(a,c,d){var e;
C(a,function(a,f,h){if(c.call(d,a,f,h))return e=a,true});return e};j.filter=j.select=function(a,c,d){var e=[];if(a==null)return e;if(s&&a.filter===s)return a.filter(c,d);q(a,function(a,f,h){c.call(d,a,f,h)&&(e[e.length]=a)});return e};j.reject=function(a,c,d){var e=[];if(a==null)return e;q(a,function(a,f,h){c.call(d,a,f,h)||(e[e.length]=a)});return e};j.every=j.all=function(a,c,d){var f=true;if(a==null)return f;if(p&&a.every===p)return a.every(c,d);q(a,function(a,h,g){if(!(f=f&&c.call(d,a,h,g)))return e});
return f};var C=j.some=j.any=function(a,c,d){var c=c||j.identity,f=false;if(a==null)return f;if(m&&a.some===m)return a.some(c,d);q(a,function(a,h,g){if(f||(f=c.call(d,a,h,g)))return e});return!!f};j.include=j.contains=function(a,c){var d;return a==null?false:w&&a.indexOf===w?a.indexOf(c)!=-1:d=C(a,function(a){return a===c})};j.invoke=function(a,c){var d=h.call(arguments,2);return j.map(a,function(a){return(c.call?c||a:a[c]).apply(a,d)})};j.pluck=function(a,c){return j.map(a,function(a){return a[c]})};
j.max=function(a,c,d){if(!c&&j.isArray(a))return Math.max.apply(Math,a);if(!c&&j.isEmpty(a))return-Infinity;var e={computed:-Infinity};q(a,function(a,f,h){f=c?c.call(d,a,f,h):a;f>=e.computed&&(e={value:a,computed:f})});return e.value};j.min=function(a,c,d){if(!c&&j.isArray(a))return Math.min.apply(Math,a);if(!c&&j.isEmpty(a))return Infinity;var e={computed:Infinity};q(a,function(a,f,h){f=c?c.call(d,a,f,h):a;f<e.computed&&(e={value:a,computed:f})});return e.value};j.shuffle=function(a){var c=[],d;
q(a,function(a,e){e==0?c[0]=a:(d=Math.floor(Math.random()*(e+1)),c[e]=c[d],c[d]=a)});return c};j.sortBy=function(a,c,d){return j.pluck(j.map(a,function(a,e,f){return{value:a,criteria:c.call(d,a,e,f)}}).sort(function(a,c){var d=a.criteria,e=c.criteria;return d<e?-1:d>e?1:0}),"value")};j.groupBy=function(a,c){var d={},e=j.isFunction(c)?c:function(a){return a[c]};q(a,function(a,c){var f=e(a,c);(d[f]||(d[f]=[])).push(a)});return d};j.sortedIndex=function(a,c,d){d||(d=j.identity);for(var e=0,f=a.length;e<
f;){var h=e+f>>1;d(a[h])<d(c)?e=h+1:f=h}return e};j.toArray=function(a){return!a?[]:a.toArray?a.toArray():j.isArray(a)?h.call(a):j.isArguments(a)?h.call(a):j.values(a)};j.size=function(a){return j.toArray(a).length};j.first=j.head=function(a,c,d){return c!=null&&!d?h.call(a,0,c):a[0]};j.initial=function(a,c,d){return h.call(a,0,a.length-(c==null||d?1:c))};j.last=function(a,c,d){return c!=null&&!d?h.call(a,Math.max(a.length-c,0)):a[a.length-1]};j.rest=j.tail=function(a,c,d){return h.call(a,c==null||
d?1:c)};j.compact=function(a){return j.filter(a,function(a){return!!a})};j.flatten=function(a,c){return j.reduce(a,function(a,d){if(j.isArray(d))return a.concat(c?d:j.flatten(d));a[a.length]=d;return a},[])};j.without=function(a){return j.difference(a,h.call(arguments,1))};j.uniq=j.unique=function(a,c,d){var d=d?j.map(a,d):a,e=[];j.reduce(d,function(d,f,h){if(0==h||(c===true?j.last(d)!=f:!j.include(d,f)))d[d.length]=f,e[e.length]=a[h];return d},[]);return e};j.union=function(){return j.uniq(j.flatten(arguments,
true))};j.intersection=j.intersect=function(a){var c=h.call(arguments,1);return j.filter(j.uniq(a),function(a){return j.every(c,function(c){return j.indexOf(c,a)>=0})})};j.difference=function(a,c){return j.filter(a,function(a){return!j.include(c,a)})};j.zip=function(){for(var a=h.call(arguments),c=j.max(j.pluck(a,"length")),d=Array(c),e=0;e<c;e++)d[e]=j.pluck(a,""+e);return d};j.indexOf=function(a,c,d){if(a==null)return-1;var e;if(d)return d=j.sortedIndex(a,c),a[d]===c?d:-1;if(w&&a.indexOf===w)return a.indexOf(c);
for(d=0,e=a.length;d<e;d++)if(a[d]===c)return d;return-1};j.lastIndexOf=function(a,c){if(a==null)return-1;if(B&&a.lastIndexOf===B)return a.lastIndexOf(c);for(var d=a.length;d--;)if(a[d]===c)return d;return-1};j.range=function(a,c,d){arguments.length<=1&&(c=a||0,a=0);for(var d=arguments[2]||1,e=Math.max(Math.ceil((c-a)/d),0),f=0,h=Array(e);f<e;)h[f++]=a,a+=d;return h};var D=function(){};j.bind=function(a,c){var d,e;if(a.bind===z&&z)return z.apply(a,h.call(arguments,1));if(!j.isFunction(a))throw new TypeError;
e=h.call(arguments,2);return d=function(){if(!(this instanceof d))return a.apply(c,e.concat(h.call(arguments)));D.prototype=a.prototype;var f=new D,g=a.apply(f,e.concat(h.call(arguments)));return Object(g)===g?g:f}};j.bindAll=function(a){var c=h.call(arguments,1);c.length==0&&(c=j.functions(a));q(c,function(c){a[c]=j.bind(a[c],a)});return a};j.memoize=function(a,c){var d={};c||(c=j.identity);return function(){var e=c.apply(this,arguments);return t.call(d,e)?d[e]:d[e]=a.apply(this,arguments)}};j.delay=
function(a,c){var d=h.call(arguments,2);return setTimeout(function(){return a.apply(a,d)},c)};j.defer=function(a){return j.delay.apply(j,[a,1].concat(h.call(arguments,1)))};j.throttle=function(a,c){var d,e,f,h,g,k=j.debounce(function(){g=h=false},c);return function(){d=this;e=arguments;f||(f=setTimeout(function(){f=null;g&&a.apply(d,e);k()},c));h?g=true:a.apply(d,e);k();h=true}};j.debounce=function(a,c){var d;return function(){var e=this,f=arguments;clearTimeout(d);d=setTimeout(function(){d=null;
a.apply(e,f)},c)}};j.once=function(a){var c=false,d;return function(){if(c)return d;c=true;return d=a.apply(this,arguments)}};j.wrap=function(a,c){return function(){var d=[a].concat(h.call(arguments));return c.apply(this,d)}};j.compose=function(){var a=h.call(arguments);return function(){for(var c=h.call(arguments),d=a.length-1;d>=0;d--)c=[a[d].apply(this,c)];return c[0]}};j.after=function(a,c){return a<=0?c():function(){if(--a<1)return c.apply(this,arguments)}};j.keys=E||function(a){if(a!==Object(a))throw new TypeError("Invalid object");
var c=[],d;for(d in a)t.call(a,d)&&(c[c.length]=d);return c};j.values=function(a){return j.map(a,j.identity)};j.functions=j.methods=function(a){var c=[],d;for(d in a)j.isFunction(a[d])&&c.push(d);return c.sort()};j.extend=function(a){q(h.call(arguments,1),function(c){for(var d in c)c[d]!==void 0&&(a[d]=c[d])});return a};j.defaults=function(a){q(h.call(arguments,1),function(c){for(var d in c)a[d]==null&&(a[d]=c[d])});return a};j.clone=function(a){return!j.isObject(a)?a:j.isArray(a)?a.slice():j.extend({},
a)};j.tap=function(a,c){c(a);return a};j.isEqual=function(c,d){return a(c,d,[])};j.isEmpty=function(a){if(j.isArray(a)||j.isString(a))return a.length===0;for(var c in a)if(t.call(a,c))return false;return true};j.isElement=function(a){return!!(a&&a.nodeType==1)};j.isArray=g||function(a){return o.call(a)=="[object Array]"};j.isObject=function(a){return a===Object(a)};j.isArguments=o.call(arguments)=="[object Arguments]"?function(a){return o.call(a)=="[object Arguments]"}:function(a){return!(!a||!t.call(a,
"callee"))};j.isFunction=function(a){return o.call(a)=="[object Function]"};j.isString=function(a){return o.call(a)=="[object String]"};j.isNumber=function(a){return o.call(a)=="[object Number]"};j.isNaN=function(a){return a!==a};j.isBoolean=function(a){return a===true||a===false||o.call(a)=="[object Boolean]"};j.isDate=function(a){return o.call(a)=="[object Date]"};j.isRegExp=function(a){return o.call(a)=="[object RegExp]"};j.isNull=function(a){return a===null};j.isUndefined=function(a){return a===
void 0};j.noConflict=function(){c._=d;return this};j.identity=function(a){return a};j.times=function(a,c,d){for(var e=0;e<a;e++)c.call(d,e)};j.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};j.mixin=function(a){q(j.functions(a),function(c){F(c,j[c]=a[c])})};var G=0;j.uniqueId=function(a){var c=G++;return a?a+c:c};j.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,
escape:/<%-([\s\S]+?)%>/g};j.template=function(a,c){var d=j.templateSettings,d="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(d.escape,function(a,c){return"',_.escape("+c.replace(/\\'/g,"'")+"),'"}).replace(d.interpolate,function(a,c){return"',"+c.replace(/\\'/g,"'")+",'"}).replace(d.evaluate||null,function(a,c){return"');"+c.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+";__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,
"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",e=new Function("obj","_",d);return c?e(c,j):function(a){return e(a,j)}};var x=function(a){this._wrapped=a};j.prototype=x.prototype;var A=function(a,c){return c?j(a).chain():a},F=function(a,c){x.prototype[a]=function(){var a=h.call(arguments);k.call(a,this._wrapped);return A(c.apply(j,a),this._chain)}};j.mixin(j);q("pop,push,reverse,shift,sort,splice,unshift".split(","),function(a){var c=f[a];x.prototype[a]=function(){c.apply(this._wrapped,arguments);
return A(this._wrapped,this._chain)}});q(["concat","join","slice"],function(a){var c=f[a];x.prototype[a]=function(){return A(c.apply(this._wrapped,arguments),this._chain)}});x.prototype.chain=function(){this._chain=true;return this};x.prototype.value=function(){return this._wrapped}}).call(this);
(function(a){var c=String.prototype.trim,d=function(a,c){for(var d=[];c>0;d[--c]=a);return d.join("")},e=function(a){return function(){for(var c=Array.prototype.slice.call(arguments),d=0;d<c.length;d++)c[d]=c[d]==null?"":""+c[d];return a.apply(null,c)}},f=function(){function a(c){return Object.prototype.toString.call(c).slice(8,-1).toLowerCase()}var c=function(){c.cache.hasOwnProperty(arguments[0])||(c.cache[arguments[0]]=c.parse(arguments[0]));return c.format.call(null,c.cache[arguments[0]],arguments)};
c.format=function(c,e){var g=1,k=c.length,l="",r=[],s,p,m,w;for(s=0;s<k;s++)if(l=a(c[s]),l==="string")r.push(c[s]);else if(l==="array"){m=c[s];if(m[2]){l=e[g];for(p=0;p<m[2].length;p++){if(!l.hasOwnProperty(m[2][p]))throw f('[_.sprintf] property "%s" does not exist',m[2][p]);l=l[m[2][p]]}}else l=m[1]?e[m[1]]:e[g++];if(/[^s]/.test(m[8])&&a(l)!="number")throw f("[_.sprintf] expecting number but found %s",a(l));switch(m[8]){case "b":l=l.toString(2);break;case "c":l=String.fromCharCode(l);break;case "d":l=
parseInt(l,10);break;case "e":l=m[7]?l.toExponential(m[7]):l.toExponential();break;case "f":l=m[7]?parseFloat(l).toFixed(m[7]):parseFloat(l);break;case "o":l=l.toString(8);break;case "s":l=(l=String(l))&&m[7]?l.substring(0,m[7]):l;break;case "u":l=Math.abs(l);break;case "x":l=l.toString(16);break;case "X":l=l.toString(16).toUpperCase()}l=/[def]/.test(m[8])&&m[3]&&l>=0?"+"+l:l;p=m[4]?m[4]=="0"?"0":m[4].charAt(1):" ";w=m[6]-String(l).length;p=m[6]?d(p,w):"";r.push(m[5]?l+p:p+l)}return r.join("")};c.cache=
{};c.parse=function(a){for(var c=[],d=[],e=0;a;){if((c=/^[^\x25]+/.exec(a))!==null)d.push(c[0]);else if((c=/^\x25{2}/.exec(a))!==null)d.push("%");else if((c=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(a))!==null){if(c[2]){e|=1;var f=[],h=c[2],g=[];if((g=/^([a-z_][a-z_\d]*)/i.exec(h))!==null)for(f.push(g[1]);(h=h.substring(g[0].length))!=="";)if((g=/^\.([a-z_][a-z_\d]*)/i.exec(h))!==null)f.push(g[1]);else if((g=/^\[(\d+)\]/.exec(h))!==null)f.push(g[1]);
else throw"[_.sprintf] huh?";else throw"[_.sprintf] huh?";c[2]=f}else e|=2;if(e===3)throw"[_.sprintf] mixing positional and named placeholders is not (yet) supported";d.push(c)}else throw"[_.sprintf] huh?";a=a.substring(c[0].length)}return d};return c}(),g={VERSION:"1.2.0",isBlank:e(function(a){return/^\s*$/.test(a)}),stripTags:e(function(a){return a.replace(/<\/?[^>]+>/ig,"")}),capitalize:e(function(a){return a.charAt(0).toUpperCase()+a.substring(1).toLowerCase()}),chop:e(function(a,c){for(var c=
c*1||a.length,d=[],e=0;e<a.length;)d.push(a.slice(e,e+c)),e+=c;return d}),clean:e(function(a){return g.strip(a.replace(/\s+/g," "))}),count:e(function(a,c){for(var d=0,e,f=0;f<a.length;)e=a.indexOf(c,f),e>=0&&d++,f=f+(e>=0?e:0)+c.length;return d}),chars:e(function(a){return a.split("")}),escapeHTML:e(function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}),unescapeHTML:e(function(a){return a.replace(/&lt;/g,"<").replace(/&gt;/g,
">").replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&amp;/g,"&")}),escapeRegExp:e(function(a){return a.replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")}),insert:e(function(a,c,d){a=a.split("");a.splice(c*1||0,0,d);return a.join("")}),include:e(function(a,c){return a.indexOf(c)!==-1}),join:e(function(a){var c=Array.prototype.slice.call(arguments);return c.join(c.shift())}),lines:e(function(a){return a.split("\n")}),reverse:e(function(a){return Array.prototype.reverse.apply(String(a).split("")).join("")}),
splice:e(function(a,c,d,e){a=a.split("");a.splice(c*1||0,d*1||0,e);return a.join("")}),startsWith:e(function(a,c){return a.length>=c.length&&a.substring(0,c.length)===c}),endsWith:e(function(a,c){return a.length>=c.length&&a.substring(a.length-c.length)===c}),succ:e(function(a){var c=a.split("");c.splice(a.length-1,1,String.fromCharCode(a.charCodeAt(a.length-1)+1));return c.join("")}),titleize:e(function(a){for(var a=a.split(" "),c,d=0;d<a.length;d++)c=a[d].split(""),typeof c[0]!=="undefined"&&(c[0]=
c[0].toUpperCase()),d+1===a.length?a[d]=c.join(""):a[d]=c.join("")+" ";return a.join("")}),camelize:e(function(a){return g.trim(a).replace(/(\-|_|\s)+(.)?/g,function(a,c,d){return d?d.toUpperCase():""})}),underscored:function(a){return g.trim(a).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/\-|\s+/g,"_").toLowerCase()},dasherize:function(a){return g.trim(a).replace(/([a-z\d])([A-Z]+)/g,"$1-$2").replace(/^([A-Z]+)/,"-$1").replace(/\_|\s+/g,"-").toLowerCase()},humanize:function(a){return g.capitalize(this.underscored(a).replace(/_id$/,
"").replace(/_/g," "))},trim:e(function(a,d){if(!d&&c)return c.call(a);d=d?g.escapeRegExp(d):"\\s";return a.replace(RegExp("^["+d+"]+|["+d+"]+$","g"),"")}),ltrim:e(function(a,c){c=c?g.escapeRegExp(c):"\\s";return a.replace(RegExp("^["+c+"]+","g"),"")}),rtrim:e(function(a,c){c=c?g.escapeRegExp(c):"\\s";return a.replace(RegExp("["+c+"]+$","g"),"")}),truncate:e(function(a,c,d){c=c*1||0;return a.length>c?a.slice(0,c)+(d||"..."):a}),prune:e(function(a,c,d){var d=d||"...",c=c*1||0,e="",e=a.substring(c-
1,c+1).search(/^\w\w$/)===0?g.rtrim(a.slice(0,c).replace(/([\W][\w]*)$/,"")):g.rtrim(a.slice(0,c)),e=e.replace(/\W+$/,"");return e.length+d.length>a.length?a:e+d}),words:function(a,c){return String(a).split(c||" ")},pad:e(function(a,c,e,f){var g="",g=0,c=c*1||0;e?e.length>1&&(e=e.charAt(0)):e=" ";switch(f){case "right":g=c-a.length;g=d(e,g);a+=g;break;case "both":g=c-a.length;g={left:d(e,Math.ceil(g/2)),right:d(e,Math.floor(g/2))};a=g.left+a+g.right;break;default:g=c-a.length,g=d(e,g),a=g+a}return a}),
lpad:function(a,c,d){return g.pad(a,c,d)},rpad:function(a,c,d){return g.pad(a,c,d,"right")},lrpad:function(a,c,d){return g.pad(a,c,d,"both")},sprintf:f,vsprintf:function(a,c){c.unshift(a);return f.apply(null,c)},toNumber:function(a,c){var d;d=(a*1||0).toFixed(c*1||0)*1||0;return!(d===0&&a!=="0"&&a!==0)?d:Number.NaN},strRight:e(function(a,c){var d=!c?-1:a.indexOf(c);return d!=-1?a.slice(d+c.length,a.length):a}),strRightBack:e(function(a,c){var d=!c?-1:a.lastIndexOf(c);return d!=-1?a.slice(d+c.length,
a.length):a}),strLeft:e(function(a,c){var d=!c?-1:a.indexOf(c);return d!=-1?a.slice(0,d):a}),strLeftBack:e(function(a,c){var d=a.lastIndexOf(c);return d!=-1?a.slice(0,d):a}),exports:function(){var a={},c;for(c in this)if(this.hasOwnProperty(c)&&!(c=="include"||c=="contains"||c=="reverse"))a[c]=this[c];return a}};g.strip=g.trim;g.lstrip=g.ltrim;g.rstrip=g.rtrim;g.center=g.lrpad;g.ljust=g.lpad;g.rjust=g.rpad;g.contains=g.include;if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports)module.exports=
g;exports._s=g}else typeof a._!=="undefined"?(a._.string=g,a._.str=a._.string):a._={string:g,str:g}})(this||window);BiwaScheme.TopEnv={};BiwaScheme.CoreEnv={};BiwaScheme.nil={toString:function(){return"nil"},to_write:function(){return"()"},to_array:function(){return[]},length:function(){return 0}};BiwaScheme.undef={};BiwaScheme.undef.toString=function(){return"#<undef>"};BiwaScheme.debug=function(){var a=_.toArray(arguments);console.debug.apply(console,_.map(a,BiwaScheme.inspect))};
BiwaScheme.Class={create:function(a){var c=function(){this.initialize.apply(this,arguments)};_.extend(c.prototype,a);return c},extend:function(a,c){var d=function(){this.initialize.apply(this,arguments)};d.prototype=a;_.extend(d.prototype,c);return d}};
BiwaScheme.Class.memoize=function(a,c){var d=a.prototype,e=_.isArray(c)?c:[c];_.each(e,function(a){d["compute_"+a]=d[a];d[a]=function(){this.hasOwnProperty("cached_"+a)||(this["cached_"+a]=this["compute_"+a].apply(this,_.toArray(arguments)));return this["cached_"+a]}})};
BiwaScheme.to_write=function(a){if(a===void 0)return"undefined";else if(a===null)return"null";else if(_.isFunction(a))return"#<Function "+(a.fname?a.fname:a.toSource?_.str.truncate(a.toSource(),40):"")+">";else if(_.isString(a))return'"'+a.replace(/\\|\"/g,function(a){return"\\"+a}).replace(/\x07/g,"\\a").replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\v/g,"\\v").replace(/\f/g,"\\f").replace(/\r/g,"\\r")+'"';else if(_.isArray(a)&&a.closure_p)return"#<Closure>";else if(_.isArray(a))return"#("+
_.map(a,function(a){return BiwaScheme.to_write(a)}).join(" ")+")";else if(typeof a.to_write=="function")return a.to_write();else if(isNaN(a)&&typeof a=="number")return"+nan.0";else switch(a){case true:return"#t";case false:return"#f";case Infinity:return"+inf.0";case -Infinity:return"-inf.0"}return BiwaScheme.inspect(a)};
BiwaScheme.to_display=function(a){return typeof a.valueOf()=="string"?a:a instanceof BiwaScheme.Symbol?a.name:a instanceof Array?"#("+_.map(a,BiwaScheme.to_display).join(" ")+")":a instanceof BiwaScheme.Pair?a.inspect(BiwaScheme.to_display):a instanceof BiwaScheme.Char?a.value:BiwaScheme.to_write(a)};
BiwaScheme.write_ss=function(a,c){var d=[a],e=[false];BiwaScheme.find_cyclic(a,d,e);for(var d=BiwaScheme.reduce_cyclic_info(d,e),e=Array(d.length),f=d.length-1;f>=0;f--)e[f]=false;return BiwaScheme.to_write_ss(a,d,e,c)};
BiwaScheme.to_write_ss=function(a,c,d,e){var f="",g=c.indexOf(a);if(g>=0)if(d[g])return"#"+g+"#";else d[g]=true,f="#"+g+"=";if(a instanceof BiwaScheme.Pair){g=[];g.push(BiwaScheme.to_write_ss(a.car,c,d,e));for(a=a.cdr;a!=BiwaScheme.nil;a=a.cdr){if(!(a instanceof BiwaScheme.Pair)||c.indexOf(a)>=0){g.push(".");g.push(BiwaScheme.to_write_ss(a,c,d,e));break}g.push(BiwaScheme.to_write_ss(a.car,c,d,e))}f+="("+g.join(" ")+")"}else a instanceof Array?(g=_.map(a,function(a){return BiwaScheme.to_write_ss(a,
c,d,e)}),f+=e?"["+g.join(", ")+"]":"#("+g.join(" ")+")"):f+=BiwaScheme.to_write(a);return f};BiwaScheme.reduce_cyclic_info=function(a,c){for(var d=0,e=0;e<c.length;e++)c[e]&&(a[d]=a[e],d++);return a.slice(0,d)};
BiwaScheme.find_cyclic=function(a,c,d){(a=a instanceof BiwaScheme.Pair?[a.car,a.cdr]:a instanceof Array?a:null)&&_.each(a,function(a){if(!(typeof a=="number"||typeof a=="string"||a===BiwaScheme.undef||a===true||a===false||a===BiwaScheme.nil||a instanceof BiwaScheme.Symbol)){var f=c.indexOf(a);f>=0?d[f]=true:(c.push(a),d.push(false),BiwaScheme.find_cyclic(a,c,d))}})};
BiwaScheme.inspect=function(a,c){try{return _.isUndefined(a)?"undefined":a===null?"null":a===true?"#t":a===false?"#f":a.inspect?a.inspect():_.isString(a)?'"'+a.replace(/"/g,'\\"')+'"':_.isArray(a)?"["+_.map(a,BiwaScheme.inspect).join(", ")+"]":c&&c.fallback?c.fallback:a.toString()}catch(d){if(d instanceof RangeError)return"...";throw d;}};BiwaScheme.isNil=function(a){return a===BiwaScheme.nil};BiwaScheme.isUndef=function(a){return a===BiwaScheme.undef};
BiwaScheme.isChar=function(a){return a instanceof BiwaScheme.Char};BiwaScheme.isSymbol=function(a){return a instanceof BiwaScheme.Symbol};BiwaScheme.isTheSymbol=function(a,c){return c instanceof BiwaScheme.Symbol&&c.name==a};BiwaScheme.isPort=function(a){return a instanceof BiwaScheme.Port};BiwaScheme.isPair=function(a){return a instanceof BiwaScheme.Pair};BiwaScheme.isList=function(a){return a===BiwaScheme.nil?true:!(a instanceof BiwaScheme.Pair)?false:BiwaScheme.isList(a.cdr)};
BiwaScheme.isVector=function(a){return a instanceof Array&&a.closure_p!==true};BiwaScheme.isHashtable=function(a){return a instanceof BiwaScheme.Hashtable};BiwaScheme.isMutableHashtable=function(a){return a instanceof BiwaScheme.Hashtable&&a.mutable};BiwaScheme.isClosure=function(a){return a instanceof Array&&a.closure_p===true};BiwaScheme.isProcedure=function(a){return BiwaScheme.isClosure(a)||_.isFunction(a)};
BiwaScheme.Error=BiwaScheme.Class.create({initialize:function(a){this.message="Error: "+a},toString:function(){return this.message}});BiwaScheme.Bug=BiwaScheme.Class.extend(new BiwaScheme.Error,{initialize:function(a){this.message="[BUG] "+a}});BiwaScheme.UserError=BiwaScheme.Class.extend(new BiwaScheme.Error,{initialize:function(a){this.message=a}});
BiwaScheme.Set=BiwaScheme.Class.create({initialize:function(){this.arr=[];var a;for(a=0;a<arguments.length;a++)this.arr[a]=arguments[a]},equals:function(a){if(this.arr.length!=a.arr.length)return false;var c=_.clone(this.arr),a=_.clone(a.arr);c.sort();a.sort();for(var d=0;d<this.arr.length;d++)if(c[d]!=a[d])return false;return true},set_cons:function(a){var c=new BiwaScheme.Set(a);c.arr=_.clone(this.arr);c.arr.push(a);return c},set_union:function(){var a=new BiwaScheme.Set;a.arr=_.clone(this.arr);
for(var c=0;c<arguments.length;c++){var d=arguments[c];if(!(d instanceof BiwaScheme.Set))throw new BiwaScheme.Error("set_union: arguments must be a set");for(var e=0;e<d.arr.length;e++)a.add(d.arr[e])}return a},set_intersect:function(a){if(!(a instanceof BiwaScheme.Set))throw new BiwaScheme.Error("set_intersect: arguments must be a set");for(var c=new BiwaScheme.Set,d=0;d<this.arr.length;d++)a.member(this.arr[d])&&c.add(this.arr[d]);return c},set_minus:function(a){if(!(a instanceof BiwaScheme.Set))throw new BiwaScheme.Error("set_minus: arguments must be a set");
for(var c=new BiwaScheme.Set,d=0;d<this.arr.length;d++)a.member(this.arr[d])||c.add(this.arr[d]);return c},add:function(a){this.member(a)||this.arr.push(a)},member:function(a){for(var c=0;c<this.arr.length;c++)if(this.arr[c]==a)return true;return false},rindex:function(a){for(var c=this.arr.length-1;c>=0;c--)if(this.arr[c]==a)return this.arr.length-1-c;return null},index:function(a){for(var c=0;c<this.arr.length;c++)if(this.arr[c]==a)return c;return null},inspect:function(){return"Set("+this.arr.join(", ")+
")"},toString:function(){return this.inspect()},size:function(){return this.arr.length}});BiwaScheme.Values=BiwaScheme.Class.create({initialize:function(a){this.content=a},to_write:function(){return"#<Values "+_.map(this.content,BiwaScheme.to_write).join(" ")+">"}});
BiwaScheme.Pair=BiwaScheme.Class.create({initialize:function(a,c){this.car=a;this.cdr=c},caar:function(){return this.car.car},cadr:function(){return this.cdr.car},cdar:function(){return this.cdr.car},cddr:function(){return this.cdr.cdr},first:function(){return this.car},second:function(){return this.cdr.car},third:function(){return this.cdr.cdr.car},fourth:function(){return this.cdr.cdr.cdr.car},fifth:function(){return this.cdr.cdr.cdr.cdr.car},to_array:function(){for(var a=[],c=this;c instanceof
BiwaScheme.Pair;c=c.cdr)a.push(c.car);return a},to_set:function(){for(var a=new BiwaScheme.Set,c=this;c instanceof BiwaScheme.Pair;c=c.cdr)a.add(c.car);return a},length:function(){for(var a=0,c=this;c instanceof BiwaScheme.Pair;c=c.cdr)a++;return a},foreach:function(a){for(var c=this;c instanceof BiwaScheme.Pair;c=c.cdr)a(c.car);return c},map:function(a){for(var c=[],d=this;BiwaScheme.isPair(d);d=d.cdr)c.push(a(d.car));return c},concat:function(a){for(var c=this;c instanceof BiwaScheme.Pair&&c.cdr!=
BiwaScheme.nil;)c=c.cdr;c.cdr=a;return this},inspect:function(a){a||(a=BiwaScheme.inspect);var c=[],d=this.foreach(function(d){c.push(a(d))});d!=BiwaScheme.nil&&(c.push("."),c.push(a(d)));return"("+c.join(" ")+")"},toString:function(){return this.inspect()},to_write:function(){return this.inspect(BiwaScheme.to_write)}});var array_to_list=function(a,c){for(var d=BiwaScheme.nil,e=a.length-1;e>=0;e--){var f=a[e];c&&_.isArray(f)&&!f.is_vector&&(f=array_to_list(f,c));d=new BiwaScheme.Pair(f,d)}return d};
BiwaScheme.List=function(){var a=_.toArray(arguments);return array_to_list(a,false)};BiwaScheme.array_to_list=function(a){return array_to_list(a,false)};BiwaScheme.deep_array_to_list=function(a){return array_to_list(a,true)};BiwaScheme.Symbol=BiwaScheme.Class.create({initialize:function(a){this.name=a;BiwaScheme.Symbols[a]=this},inspect:function(){return"'"+this.name},toString:function(){return"'"+this.name},to_write:function(){return this.name}});BiwaScheme.Symbols={};
BiwaScheme.Sym=function(a){return BiwaScheme.Symbols[a]===void 0?new BiwaScheme.Symbol(a):BiwaScheme.Symbols[a]instanceof BiwaScheme.Symbol?BiwaScheme.Symbols[a]:new BiwaScheme.Symbol(a)};BiwaScheme.gensym=function(){return BiwaScheme.Sym(_.uniqueId("__gensym"))};
BiwaScheme.Char=BiwaScheme.Class.create({initialize:function(a){BiwaScheme.Chars[this.value=a]=this},to_write:function(){switch(this.value){case "\n":return"#\\newline";case " ":return"#\\space";case "\t":return"#\\tab";default:return"#\\"+this.value}},inspect:function(){return this.to_write()}});BiwaScheme.Chars={};
BiwaScheme.Char.get=function(a){if(typeof a!="string")throw new BiwaScheme.Bug("Char.get: "+BiwaScheme.inspect(a)+" is not a string");return BiwaScheme.Chars[a]===void 0?new BiwaScheme.Char(a):BiwaScheme.Chars[a]};BiwaScheme.Complex=BiwaScheme.Class.create({initialize:function(a,c){this.real=a;this.imag=c},magnitude:function(){return Math.sqrt(this.real*this.real+this.imag*this.imag)},angle:function(){return Math.acos(this.real/this.magnitude())}});
BiwaScheme.Complex.from_polar=function(a,c){var d=a*Math.cos(c),e=a*Math.sin(c);return new BiwaScheme.Complex(d,e)};BiwaScheme.Complex.assure=function(a){return a instanceof BiwaScheme.Complex?a:new BiwaScheme.Complex(a,0)};BiwaScheme.Rational=BiwaScheme.Class.create({initialize:function(a,c){this.numerator=a;this.denominator=c}});BiwaScheme.eof={};
BiwaScheme.Port=BiwaScheme.Class.create({initialize:function(a,c){this.is_open=true;this.is_binary=false;this.is_input=a;this.is_output=c},close:function(){this.is_open=false},inspect:function(){return"#<Port>"},to_write:function(){return"#<Port>"}});BiwaScheme.Port.StringOutput=BiwaScheme.Class.extend(new BiwaScheme.Port(false,true),{initialize:function(){this.buffer=[]},put_string:function(a){this.buffer.push(a)},output_string:function(){return this.buffer.join("")}});
BiwaScheme.Port.StringInput=BiwaScheme.Class.extend(new BiwaScheme.Port(true,false),{initialize:function(a){this.str=a},get_string:function(a){return a(this.str)}});BiwaScheme.Port.NullInput=BiwaScheme.Class.extend(new BiwaScheme.Port(true,false),{initialize:function(){},get_string:function(a){return a("")}});BiwaScheme.Port.NullOutput=BiwaScheme.Class.extend(new BiwaScheme.Port(false,true),{initialize:function(a){this.output_function=a},put_string:function(){}});
BiwaScheme.Port.CustomOutput=BiwaScheme.Class.extend(new BiwaScheme.Port(false,true),{initialize:function(a){this.output_function=a},put_string:function(a){this.output_function(a)}});BiwaScheme.Port.CustomInput=BiwaScheme.Class.extend(new BiwaScheme.Port(true,false),{initialize:function(a){this.input_function=a},get_string:function(a){var c=this.input_function;return new BiwaScheme.Pause(function(d){c(function(c){d.resume(a(c))})})}});BiwaScheme.Port.current_input=new BiwaScheme.Port.NullInput;
BiwaScheme.Port.current_output=new BiwaScheme.Port.NullOutput;BiwaScheme.Port.current_error=new BiwaScheme.Port.NullOutput;BiwaScheme.Record=BiwaScheme.Class.create({initialize:function(a,c){BiwaScheme.assert_record_td(a,"new Record");this.rtd=a;this.fields=c},get:function(a){return this.fields[a]},set:function(a,c){this.fields[a]=c},toString:function(){return"#<Record "+this.rtd.name+" "+BiwaScheme.to_write(this.fields)+">"}});BiwaScheme.isRecord=function(a){return a instanceof BiwaScheme.Record};
BiwaScheme.Record._DefinedTypes={};BiwaScheme.Record.define_type=function(a,c,d){return BiwaScheme.Record._DefinedTypes[a]={rtd:c,cd:d}};BiwaScheme.Record.get_type=function(a){return BiwaScheme.Record._DefinedTypes[a]};
BiwaScheme.Record.RTD=BiwaScheme.Class.create({initialize:function(a,c,d,e,f,g){this.name=a;this.parent_rtd=c;this.is_base_type=!c;d?(this.uid=d,this.generative=false):(this.uid=this._generate_new_uid(),this.generative=true);this.sealed=!!e;this.opaque=c.opaque||!!f;this.fields=_.map(g,function(a){return{name:a[0],mutable:!!a[1]}})},field_name:function(a){var c=this._field_names();for(par=this.parent_rtd;par;par=par.parent_rtd)c=par._field_names()+c;return c[a]},_field_names:function(){return _.map(this.fields,
function(a){return a.name})},_generate_new_uid:function(){return BiwaScheme.Sym(_.uniqueId("__record_td_uid"))},toString:function(){return"#<RecordTD "+name+">"}});BiwaScheme.Record.RTD.NongenerativeRecords={};BiwaScheme.isRecordTD=function(a){return a instanceof BiwaScheme.Record.RTD};
BiwaScheme.Record.CD=BiwaScheme.Class.create({initialize:function(a,c,d){this._check(a,c,d);this.rtd=a;this.parent_cd=c;d?(this.has_custom_protocol=true,this.protocol=d):(this.has_custom_protocol=false,this.protocol=a.parent_rtd?this._default_protocol_for_derived_types():this._default_protocol_for_base_types())},_check:function(a,c,d){if(a.is_base_type&&c)throw Error("Record.CD.new: cannot specify parent cd of a base type");if(c&&a.parent_rtd&&c.rtd!=a.parent_rtd)throw Error("Record.CD.new: mismatched parents between rtd and parent_cd");
if(a.parent_rtd&&!c&&d)throw Error("Record.CD.new: protocol must be #f when parent_cd is not given");if(c&&c.has_custom_protocol&&!d)throw Error("Record.CD.new: protocol must be specified when parent_cd has a custom protocol");},_default_protocol_for_base_types:function(){return function(a){a=a[0];BiwaScheme.assert_procedure(a,"_default_protocol/base");return a}},_default_protocol_for_derived_types:function(){var a=this.rtd;return function(c){var d=c[0];BiwaScheme.assert_procedure(d,"_default_protocol/n");
return function(c){var f=c.length-a.fields.length,g=c.slice(0,f),h=c.slice(f);return new BiwaScheme.Call(d,g,function(a){a=a[0];BiwaScheme.assert_procedure(a,"_default_protocol/p");return new BiwaScheme.Call(a,h,function(a){a=a[0];BiwaScheme.assert_record(a,"_default_protocol/result");return a})})}}},toString:function(){return"#<RecordCD "+this.rtd.name+">"},record_constructor:function(){var a=this.parent_cd?this._make_n([],this.rtd):this._make_p(),a=_.bind(a,this);return new BiwaScheme.Call(this.protocol,
[a],function(a){a=a[0];BiwaScheme.assert_procedure(a,"record_constructor");return a})},_make_p:function(){return function(a){return new BiwaScheme.Record(this.rtd,a)}},_make_n:function(a,c){var d=this.parent_cd;return d?function(e){return function(f){f=[].concat(f[0]).concat(a);f=d._make_n(f,c);return new BiwaScheme.Call(d.protocol,[f],function(a){a=a[0];BiwaScheme.assert_procedure(a,"_make_n");return new BiwaScheme.Call(a,e,function(a){a=a[0];BiwaScheme.assert_record(a);return a})})}}:function(d){d=
d.concat(a);return new BiwaScheme.Record(c,d)}}});BiwaScheme.isRecordCD=function(a){return a instanceof BiwaScheme.Record.CD};BiwaScheme.Enumeration={};
BiwaScheme.Enumeration.EnumType=BiwaScheme.Class.create({initialize:function(a){this.members=_.uniq(a)},universe:function(){return new BiwaScheme.Enumeration.EnumSet(this,this.members)},indexer:function(){return _.bind(function(a){BiwaScheme.assert_symbol(a[0],"(enum-set indexer)");a=_.indexOf(this.members,a[0]);return a===-1?false:a},this)},constructor:function(){return _.bind(function(a){BiwaScheme.assert_list(a[0],"(enum-set constructor)");a=a[0].to_array();_.each(a,function(a){BiwaScheme.assert_symbol(a,
"(enum-set constructor)")});return new BiwaScheme.Enumeration.EnumSet(this,a)},this)}});BiwaScheme.Class.memoize(BiwaScheme.Enumeration.EnumType,["universe","indexer","constructor"]);
BiwaScheme.Enumeration.EnumSet=BiwaScheme.Class.create({initialize:function(a,c){this.enum_type=a;this.symbols=_.filter(a.members,function(a){return _.include(c,a)})},symbol_list:function(){return BiwaScheme.array_to_list(this.symbols)},is_member:function(a){return _.include(this.symbols,a)},is_subset:function(a){return _.any(this.symbols,function(c){return!_.include(a.symbols,c)})?false:this.enum_type===a.enum_type?true:_.all(this.enum_type.members,function(c){return _.include(a.enum_type.members,
c)})},equal_to:function(a){return this.is_subset(a)&&a.is_subset(this)},union:function(a){var c=_.filter(this.enum_type.members,_.bind(function(c){return _.include(this.symbols,c)||_.include(a.symbols,c)},this));return new BiwaScheme.Enumeration.EnumSet(this.enum_type,c)},intersection:function(a){var c=_.filter(this.symbols,function(c){return _.include(a.symbols,c)});return new BiwaScheme.Enumeration.EnumSet(this.enum_type,c)},difference:function(a){var c=_.filter(this.symbols,function(c){return!_.include(a.symbols,
c)});return new BiwaScheme.Enumeration.EnumSet(this.enum_type,c)},complement:function(){var a=_.filter(this.enum_type.members,_.bind(function(a){return!_.include(this.symbols,a)},this));return new BiwaScheme.Enumeration.EnumSet(this.enum_type,a)},projection:function(a){var c=_.filter(this.symbols,function(c){return _.include(a.enum_type.members,c)});return new BiwaScheme.Enumeration.EnumSet(a.enum_type,c)},toString:function(){return"#<EnumSet "+BiwaScheme.inspect(this.symbols)+">"}});
BiwaScheme.Class.memoize(BiwaScheme.Enumeration.EnumSet,"symbol_list");BiwaScheme.isEnumSet=function(a){return a instanceof BiwaScheme.Enumeration.EnumSet};
BiwaScheme.Hashtable=BiwaScheme.Class.create({initialize:function(a,c,d){this.mutable=d===void 0?true:d?true:false;this.hash_proc=a;this.equiv_proc=c;this.pairs_of={}},clear:function(){this.pairs_of={}},candidate_pairs:function(a){return this.pairs_of[a]},add_pair:function(a,c,d){var e=this.pairs_of[a];e?e.push([c,d]):this.pairs_of[a]=[[c,d]]},remove_pair:function(a,c){var d=this.pairs_of[a],e=d.indexOf(c);if(e==-1)throw new BiwaScheme.Bug("Hashtable#remove_pair: pair not found!");else d.splice(e,
1)},create_copy:function(a){var c=new BiwaScheme.Hashtable(this.hash_proc,this.equiv_proc,a);_.each(_.keys(this.pairs_of),_.bind(function(a){var e=_.map(this.pairs_of[a],function(a){return _.clone(a)});c.pairs_of[a]=e},this));return c},size:function(){var a=0;this._apply_pair(function(){a++});return a},keys:function(){return this._apply_pair(function(a){return a[0]})},values:function(){return this._apply_pair(function(a){return a[1]})},_apply_pair:function(a){var c=[];_.each(_.values(this.pairs_of),
function(d){_.each(d,function(d){c.push(a(d))})});return c},to_write:function(){return"#<Hashtable size="+this.size()+">"}});BiwaScheme.Hashtable.equal_hash=function(a){return BiwaScheme.to_write(a[0])};BiwaScheme.Hashtable.eq_hash=BiwaScheme.Hashtable.equal_hash;BiwaScheme.Hashtable.eqv_hash=BiwaScheme.Hashtable.equal_hash;BiwaScheme.Hashtable.string_hash=function(a){return a[0]};BiwaScheme.Hashtable.string_ci_hash=function(a){return _.isString(a[0])?a[0].toLowerCase():a[0]};
BiwaScheme.Hashtable.symbol_hash=function(a){return a[0]instanceof BiwaScheme.Symbol?a[0].name:a[0]};BiwaScheme.Hashtable.eq_equiv=function(a){return BiwaScheme.eq(a[0],a[1])};BiwaScheme.Hashtable.eqv_equiv=function(a){return BiwaScheme.eqv(a[0],a[1])};
BiwaScheme.Syntax=BiwaScheme.Class.create({initialize:function(a,c){this.sname=a;this.func=c},transform:function(a){if(!this.func)throw new BiwaScheme.Bug("sorry, syntax "+this.sname+" is a pseudo syntax now");return this.func(a)},inspect:function(){return"#<Syntax "+this.sname+">"}});BiwaScheme.TopEnv.define=new BiwaScheme.Syntax("define");BiwaScheme.TopEnv.begin=new BiwaScheme.Syntax("begin");BiwaScheme.TopEnv.quote=new BiwaScheme.Syntax("quote");BiwaScheme.TopEnv.lambda=new BiwaScheme.Syntax("lambda");
BiwaScheme.TopEnv["if"]=new BiwaScheme.Syntax("if");BiwaScheme.TopEnv["set!"]=new BiwaScheme.Syntax("set!");
BiwaScheme.Parser=BiwaScheme.Class.create({initialize:function(a){this.tokens=this.tokenize(a);this.i=0},inspect:function(){return["#<Parser:",this.i,"/",this.tokens.length," ",BiwaScheme.inspect(this.tokens),">"].join("")},tokenize:function(a){for(var c=[],d=null,e=0;a!=""&&d!=a;)d=a,a=a.replace(/^\s*(;[^\r\n]*(\r|\n|$)|#;|#\||#\\[^\w]|#?(\(|\[|{)|\)|\]|}|\'|`|,@|,|\+inf\.0|-inf\.0|\+nan\.0|\"(\\(.|$)|[^\"\\])*(\"|$)|[^\s()\[\]{}]+)/,function(a,d){if(d=="#|")return e++,"";else if(e>0)if(/(.*\|#)/.test(d)){e--;
if(e<0)throw new BiwaScheme.Error("Found an extra comment terminator: `|#'");return d.substring(RegExp.$1.length,d.length)}else return"";else return d.charAt(0)!=";"&&(c[c.length]=d),""});return c},sexpCommentMarker:{},getObject:function(){var a=this.getObject0();if(a!=this.sexpCommentMarker)return a;a=this.getObject();if(a==BiwaScheme.Parser.EOS)throw new BiwaScheme.Error("Readable object not found after S exression comment");return a=this.getObject()},getList:function(){for(var a=BiwaScheme.nil,
c=a;this.i<this.tokens.length;){this.eatObjectsInSexpComment("Input stream terminated unexpectedly(in list)");if(this.tokens[this.i]==")"||this.tokens[this.i]=="]"||this.tokens[this.i]=="}"){this.i++;break}if(this.tokens[this.i]=="."){this.i++;var d=this.getObject();if(d!=BiwaScheme.Parser.EOS&&a!=BiwaScheme.nil)c.cdr=d}else d=new BiwaScheme.Pair(this.getObject(),BiwaScheme.nil),a==BiwaScheme.nil?a=d:c.cdr=d,c=d}return a},getVector:function(){for(var a=[];this.i<this.tokens.length;){this.eatObjectsInSexpComment("Input stream terminated unexpectedly(in vector)");
if(this.tokens[this.i]==")"||this.tokens[this.i]=="]"||this.tokens[this.i]=="}"){this.i++;break}a[a.length]=this.getObject()}return a},eatObjectsInSexpComment:function(a){for(;this.tokens[this.i]=="#;";)if(this.i++,this.getObject()==BiwaScheme.Parser.EOS||this.i>=this.tokens.length)throw new BiwaScheme.Error(a);},getObject0:function(){if(this.i>=this.tokens.length)return BiwaScheme.Parser.EOS;var a=this.tokens[this.i++];if(a=="#;")return this.sexpCommentMarker;var c=a=="'"?"quote":a=="`"?"quasiquote":
a==","?"unquote":a==",@"?"unquote-splicing":false;if(c||a=="("||a=="#("||a=="["||a=="#["||a=="{"||a=="#{")return c?new BiwaScheme.Pair(BiwaScheme.Sym(c),new BiwaScheme.Pair(this.getObject(),BiwaScheme.nil)):a=="("||a=="["||a=="{"?this.getList(a):this.getVector(a);else{switch(a){case "+inf.0":return Infinity;case "-inf.0":return-Infinity;case "+nan.0":return NaN}c=/^#x[0-9a-z]+$/i.test(a)?new Number("0x"+a.substring(2,a.length)):/^#d[0-9\.]+$/i.test(a)?new Number(a.substring(2,a.length)):new Number(a);
if(isNaN(c))if(a=="#f"||a=="#F")return false;else if(a=="#t"||a=="#T")return true;else if(a.toLowerCase()=="#\\newline")return BiwaScheme.Char.get("\n");else if(a.toLowerCase()=="#\\space")return BiwaScheme.Char.get(" ");else if(a.toLowerCase()=="#\\tab")return BiwaScheme.Char.get("\t");else if(/^#\\.$/.test(a))return BiwaScheme.Char.get(a.charAt(2));else if(/^#\\x[a-zA-Z0-9]+$/.test(a))if(a=parseInt(a.slice(3),16),a>=55296&&a<=57343)throw new BiwaScheme.Error("Character in Unicode excluded range.");
else if(a>65535)throw new BiwaScheme.Error("Character literal out of range.");else return BiwaScheme.Char.get(String.fromCharCode(a));else return/^\"(\\(.|$)|[^\"\\])*\"?$/.test(a)?a.replace(/(\r?\n|\\n)/g,"\n").replace(/^\"|\\(.|$)|\"$/g,function(a,c){return c?c:""}):BiwaScheme.Sym(a);else return c.valueOf()}}});BiwaScheme.Parser.EOS={};
BiwaScheme.Compiler=BiwaScheme.Class.create({initialize:function(){},is_tail:function(a){return a[0]=="return"},collect_free:function(a,c,d){for(var a=a.arr,e=0;e<a.length;e++)d=this.compile_refer(a[e],c,["argument",d]);return d},compile_refer:function(a,c,d){return this.compile_lookup(a,c,function(a){return["refer-local",a,d]},function(a){return["refer-free",a,d]},function(a){return["refer-global",a,d]})},compile_lookup:function(a,c,d,e,f){var g=c[1];return(n=c[0].index(a))!=null?d(n):(n=g.index(a))!=
null?e(n):f(a.name)},make_boxes:function(a,c,d){for(var e=0,f=[];c instanceof BiwaScheme.Pair;)a.member(c.car)&&f.push(e),e++,c=c.cdr;a=d;for(c=f.length-1;c>=0;c--)a=["box",f[c],a];return a},find_sets:function(a,c){var d=null;if(a instanceof BiwaScheme.Symbol)d=new BiwaScheme.Set;else if(a instanceof BiwaScheme.Pair)switch(a.first()){case BiwaScheme.Sym("define"):d=a.third(),this.find_sets(d,c);case BiwaScheme.Sym("begin"):d=this.find_sets(a.cdr,c);break;case BiwaScheme.Sym("quote"):d=new BiwaScheme.Set;
break;case BiwaScheme.Sym("lambda"):var d=a.second(),e=a.cdr.cdr,d=d instanceof BiwaScheme.Pair?this.find_sets(e,c.set_minus(d.to_set())):this.find_sets(e,c.set_minus(new BiwaScheme.Set(d)));break;case BiwaScheme.Sym("if"):var d=a.second(),e=a.third(),f=a.fourth(),d=this.find_sets(d,c).set_union(this.find_sets(e,c),this.find_sets(f,c));break;case BiwaScheme.Sym("set!"):d=a.second();e=a.third();d=c.member(d)?this.find_sets(e,c).set_cons(d):this.find_sets(e,c);break;case BiwaScheme.Sym("call/cc"):d=
a.second();d=this.find_sets(d,c);break;default:d=new BiwaScheme.Set;for(e=a;e instanceof BiwaScheme.Pair;e=e.cdr)d=d.set_union(this.find_sets(e.car,c))}else d=new BiwaScheme.Set;if(d==null)throw new BiwaScheme.Bug("find_sets() exited in unusual way");else return d},find_free:function(a,c,d){var e=null;if(a instanceof BiwaScheme.Symbol)e=d.member(a)?new BiwaScheme.Set(a):new BiwaScheme.Set;else if(a instanceof BiwaScheme.Pair)switch(a.first()){case BiwaScheme.Sym("define"):a=a.third();e=this.find_free(a,
c,d);break;case BiwaScheme.Sym("begin"):e=this.find_free(a.cdr,c,d);break;case BiwaScheme.Sym("quote"):e=new BiwaScheme.Set;break;case BiwaScheme.Sym("lambda"):e=a.second();a=a.cdr.cdr;e=e instanceof BiwaScheme.Pair?this.find_free(a,c.set_union(e.to_set()),d):this.find_free(a,c.set_cons(e),d);break;case BiwaScheme.Sym("if"):var e=a.second(),f=a.third(),a=a.fourth(),e=this.find_free(e,c,d).set_union(this.find_free(f,c,d),this.find_free(a,c,d));break;case BiwaScheme.Sym("set!"):e=a.second();a=a.third();
e=d.member(e)?this.find_free(a,c,d).set_cons(e):this.find_free(a,c,d);break;case BiwaScheme.Sym("call/cc"):a=a.second();e=this.find_free(a,c,d);break;default:for(e=new BiwaScheme.Set;a instanceof BiwaScheme.Pair;a=a.cdr)e=e.set_union(this.find_free(a.car,c,d))}else e=new BiwaScheme.Set;if(e==null)throw new BiwaScheme.Bug("find_free() exited in unusual way");else return e},find_dot_pos:function(a){for(var c=0;a instanceof BiwaScheme.Pair;a=a.cdr,++c);return a!=BiwaScheme.nil?c:-1},last_pair:function(a){if(a instanceof
BiwaScheme.Pair)for(;a.cdr instanceof BiwaScheme.Pair;a=a.cdr);return a},dotted2proper:function(a){if(a instanceof BiwaScheme.Pair){var c=this.last_pair(a);if(!(c instanceof BiwaScheme.Pair&&c.cdr===BiwaScheme.nil)){for(var d=BiwaScheme.nil;a instanceof BiwaScheme.Pair;a=a.cdr)d=new BiwaScheme.Pair(a.car,d);a=d;for(d=BiwaScheme.nil;a instanceof BiwaScheme.Pair;){var e=a.cdr;a.cdr=d;d=a;a=e}a=d;this.last_pair(a).cdr=new BiwaScheme.Pair(c.cdr,BiwaScheme.nil)}return a}else return new BiwaScheme.Pair(a,
BiwaScheme.nil)},compile:function(a,c,d,e,f){for(var g=null;;)if(a instanceof BiwaScheme.Symbol)return this.compile_refer(a,c,d.member(a)?["indirect",f]:f);else if(a instanceof BiwaScheme.Pair)switch(a.first()){case BiwaScheme.Sym("define"):g=this._compile_define(a,f);a=g[0];f=g[1];break;case BiwaScheme.Sym("begin"):for(var g=[],h=a.cdr;h instanceof BiwaScheme.Pair;h=h.cdr)g.push(h.car);a=f;for(h=g.length-1;h>=0;h--)a=this.compile(g[h],c,d,e,a);return a;case BiwaScheme.Sym("quote"):if(a.length()<
2)throw new BiwaScheme.Error("Invalid quote: "+a.to_write());return["constant",a.second(),f];case BiwaScheme.Sym("lambda"):return this._compile_lambda(a,c,d,e,f);case BiwaScheme.Sym("if"):if(a.length()<3||a.length()>4)throw new BiwaScheme.Error("Invalid if: "+a.to_write());var g=a.second(),h=a.third(),k=a.fourth(),h=this.compile(h,c,d,e,f),k=this.compile(k,c,d,e,f),a=g,f=["test",h,k];break;case BiwaScheme.Sym("set!"):if(a.length()!=3)throw new BiwaScheme.Error("Invalid set!: "+a.to_write());g=a.second();
a=a.third();f=this.compile_lookup(g,c,function(a){return["assign-local",a,f]},function(a){return["assign-free",a,f]},function(a){return["assign-global",a,f]});break;case BiwaScheme.Sym("call/cc"):return a=a.second(),a=["conti",this.is_tail(f)?c[0].size()+1:0,["argument",["constant",1,["argument",this.compile(a,c,d,e,this.is_tail(f)?["shift",1,["tco_hinted_apply"]]:["apply"])]]]],this.is_tail(f)?a:["frame",a,f];default:g=a.cdr;a=this.compile(a.car,c,d,e,this.is_tail(f)?["shift",g.length(),["tco_hinted_apply"]]:
["apply"]);a=this.compile(g.length(),c,d,e,["argument",a]);for(h=g;h instanceof BiwaScheme.Pair;h=h.cdr)a=this.compile(h.car,c,d,e,["argument",a]);return this.is_tail(f)?a:["frame",a,f]}else return["constant",a,f]},_compile_define:function(a,c){if(a.length()==1)throw new BiwaScheme.Error("Invalid `define': "+a.to_write());var d=a.cdr.car,e=a.cdr.cdr;if(d instanceof BiwaScheme.Symbol){if(e===BiwaScheme.nil)a=BiwaScheme.undef;else if(e.cdr===BiwaScheme.nil)a=e.car;else throw new BiwaScheme.Error("Invalid `define': "+
a.to_write());BiwaScheme.TopEnv[d.name]=BiwaScheme.undef;c=["assign-global",d.name,c]}else if(d instanceof BiwaScheme.Pair){var f=d.car,d=d.cdr,a=new BiwaScheme.Pair(BiwaScheme.Sym("lambda"),new BiwaScheme.Pair(d,e));BiwaScheme.TopEnv[f.name]=BiwaScheme.undef;c=["assign-global",f.name,c]}else throw new BiwaScheme.Error("define: symbol or pair expected but got "+d);return[a,c]},_compile_lambda:function(a,c,d,e,f){if(a.length()<3)throw new BiwaScheme.Error("Invalid lambda: "+a.to_write());var g=a.cdr.car,
h=BiwaScheme.Compiler.transform_internal_define(a.cdr.cdr),h=BiwaScheme.isPair(h)&&BiwaScheme.isSymbol(h.car)&&h.car.name=="letrec*"?BiwaScheme.Interpreter.expand(h):new BiwaScheme.Pair(BiwaScheme.Sym("begin"),a.cdr.cdr),a=this.find_dot_pos(g),k=this.dotted2proper(g),g=this.find_free(h,k.to_set(),e),o=this.find_sets(h,k.to_set()),d=this.compile(h,[k.to_set(),g],o.set_union(d.set_intersect(g)),e.set_union(k.to_set()),["return"]),f=["close",g.size(),this.make_boxes(o,k,d),f,a];return this.collect_free(g,
c,f)},run:function(a){return this.compile(a,[new BiwaScheme.Set,new BiwaScheme.Set],new BiwaScheme.Set,new BiwaScheme.Set,["halt"])}});BiwaScheme.Compiler.compile=function(a,c){a=BiwaScheme.Interpreter.expand(a);return(new BiwaScheme.Compiler).run(a,c)};
(function(){var a=function(a){var d=a.cdr.car,e=a.cdr.cdr;return BiwaScheme.isSymbol(d)?new BiwaScheme.Pair(d,e):(a=d.car,d=new BiwaScheme.Pair(BiwaScheme.Sym("lambda"),new BiwaScheme.Pair(d.cdr,e)),BiwaScheme.List(a,d))};BiwaScheme.Compiler.transform_internal_define=function(c){for(var d=[],e=c;BiwaScheme.isPair(e.car)&&BiwaScheme.isTheSymbol("define",e.car.car);)d.push(e.car),e=e.cdr;if(d.length==0)return c;c=BiwaScheme.List.apply(null,_.map(d,a));return new BiwaScheme.Pair(BiwaScheme.Sym("letrec*"),
new BiwaScheme.Pair(c,e))}})();BiwaScheme.Pause=BiwaScheme.Class.create({initialize:function(a){this.on_pause=a},set_state:function(a,c,d,e,f){this.interpreter=a;this.x=c;this.f=d;this.c=e;this.s=f},ready:function(){this.on_pause(this)},resume:function(a){return this.interpreter.resume(true,a,this.x,this.f,this.c,this.s)}});
BiwaScheme.Call=BiwaScheme.Class.create({initialize:function(a,c,d){this.proc=a;this.args=c;this.after=d||function(a){return a[0]}},inspect:function(){return"#<Call args="+this.args.inspect()+">"},toString:function(){return"#<Call>"},to_write:function(){return"#<Call>"}});
BiwaScheme.Iterator={ForArray:BiwaScheme.Class.create({initialize:function(a){this.arr=a;this.i=0},has_next:function(){return this.i<this.arr.length},next:function(){return this.arr[this.i++]}}),ForString:BiwaScheme.Class.create({initialize:function(a){this.str=a;this.i=0},has_next:function(){return this.i<this.str.length},next:function(){return BiwaScheme.Char.get(this.str.charAt(this.i++))}}),ForList:BiwaScheme.Class.create({initialize:function(a){this.ls=a},has_next:function(){return this.ls instanceof
BiwaScheme.Pair&&this.ls!=BiwaScheme.nil},next:function(){var a=this.ls;this.ls=this.ls.cdr;return a}}),ForMulti:BiwaScheme.Class.create({initialize:function(a){this.objs=a;this.size=a.length;this.iterators=_.map(a,function(a){return BiwaScheme.Iterator.of(a)})},has_next:function(){for(var a=0;a<this.size;a++)if(!this.iterators[a].has_next())return false;return true},next:function(){return _.map(this.iterators,function(a){return a.next()})}}),of:function(a){switch(true){case a instanceof Array:return new this.ForArray(a);
case typeof a=="string":return new this.ForString(a);case a instanceof BiwaScheme.Pair:case a===BiwaScheme.nil:return new this.ForList(a);default:throw new BiwaScheme.Bug("Iterator.of: unknown class: "+BiwaScheme.inspect(a));}}};BiwaScheme.Call.default_callbacks={call:function(a){return new BiwaScheme.Call(this.proc,[a])},result:function(){},finish:function(){}};
BiwaScheme.Call.foreach=function(a,c,d){d||(d=false);_.each(["call","result","finish"],function(a){c[a]||(c[a]=BiwaScheme.Call.default_callbacks[a])});var e=null,f=null,g=function(h){if(e){if(h=c.result(h[0],f),h!==void 0)return h}else e=d?new BiwaScheme.Iterator.ForMulti(a):BiwaScheme.Iterator.of(a);return e.has_next()?(f=e.next(),h=c.call(f),h.after=g,h):c.finish()};return g(null)};BiwaScheme.Call.multi_foreach=function(a,c){return BiwaScheme.Call.foreach(a,c,true)};
BiwaScheme.Interpreter=BiwaScheme.Class.create({initialize:function(){var a=null,c=null;arguments.length==2?(a=arguments[0],c=arguments[1]):arguments.length==1&&arguments[0]instanceof BiwaScheme.Interpreter?a=arguments[0]:arguments.length==1&&typeof arguments[0]=="function"&&(c=arguments[0]);this.stack=[];this.on_error=c||(a?a.on_error:function(){});this.after_evaluate=function(){};this.last_refer=a?a.last_refer:null;this.call_stack=a?_.clone(a.call_stack):[];this.tco_counter=[]},inspect:function(){return["#<Interpreter: stack size=>",
this.stack.length," after_evaluate=",BiwaScheme.inspect(this.after_evaluate),">"].join("")},push:function(a,c){this.stack[c]=a;return c+1},save_stack:function(a){for(var c=[],d=0;d<a;d++)c[d]=this.stack[d];return{stack:c,last_refer:this.last_refer,call_stack:_.clone(this.call_stack),tco_counter:_.clone(this.tco_counter)}},restore_stack:function(a){v=a.stack;for(var c=v.length,d=0;d<c;d++)this.stack[d]=v[d];this.last_refer=a.last_refer;this.call_stack=_.clone(a.call_stack);this.tco_counter=_.clone(a.tco_counter);
return c},continuation:function(a,c){return this.closure(["refer-local",0,["nuate",this.save_stack(this.push(c,a)),["return"]]],0,null,-1)},shift_args:function(a,c,d){for(a-=1;a>=-1;a--)this.index_set(d,a+c+1,this.index(d,a));return d-c-1},index:function(a,c){return this.stack[a-c-2]},index_set:function(a,c,d){this.stack[a-c-2]=d},closure:function(a,c,d,e){var f=[];f[0]=a;for(a=0;a<c;a++)f[a+1]=this.index(d,a-1);f[c+1]=e;f.closure_p=true;return f},execute:function(a,c,d,e,f){var g=null;try{g=this._execute(a,
c,d,e,f)}catch(h){return h.message=h.message+" ["+this.call_stack.join(", ")+"]",this.on_error(h,{a:a,x:c,f:d,c:e,s:f,stack:this.stack})}return g},run_dump_hook:function(a,c,d,e,f){var g;if(this.dumper)g=this.dumper;else if(BiwaScheme.Interpreter.dumper)g=BiwaScheme.Interpreter.dumper;else return;g&&(a={a:a,f:d,c:e,s:f,x:c,stack:this.stack},g.dump(a))},_execute:function(a,c,d,e,f){for(var g=null;;)switch(this.run_dump_hook(a,c,d,e,f),c[0]){case "halt":return a;case "refer-local":var h=c[1],c=c[2],
a=this.index(d,h);this.last_refer="(anon)";break;case "refer-free":h=c[1];c=c[2];a=e[h+1];this.last_refer="(anon)";break;case "refer-global":g=c[1];c=c[2];if(BiwaScheme.TopEnv.hasOwnProperty(g))a=BiwaScheme.TopEnv[g];else if(BiwaScheme.CoreEnv.hasOwnProperty(g))a=BiwaScheme.CoreEnv[g];else throw new BiwaScheme.Error("execute: unbound symbol: "+BiwaScheme.inspect(g));this.last_refer=g||"(anon)";break;case "indirect":c=c[1];a=a[0];break;case "constant":a=c[1];c=c[2];this.last_refer="(anon)";break;case "close":var g=
c,h=g[1],a=g[2],c=g[3],k=g[4],a=this.closure(a,h,f,k);f-=h;break;case "box":h=c[1];c=c[2];this.index_set(f,h,[this.index(f,h)]);break;case "test":g=c[1];c=c[2];c=a!==false?g:c;break;case "assign-global":g=c[1];c=c[2];if(!BiwaScheme.TopEnv.hasOwnProperty(g)&&!BiwaScheme.CoreEnv.hasOwnProperty(g))throw new BiwaScheme.Error("global variable '"+g+"' is not defined");BiwaScheme.TopEnv[g]=a;a=BiwaScheme.undef;break;case "assign-local":h=c[1];c=c[2];g=this.index(d,h);g[0]=a;a=BiwaScheme.undef;break;case "assign-free":h=
c[1];c=c[2];g=e[h+1];g[0]=a;a=BiwaScheme.undef;break;case "conti":h=c[1];c=c[2];a=this.continuation(f,h);break;case "nuate":f=c[1];c=c[2];f=this.restore_stack(f);break;case "frame":g=c[2];c=c[1];f=this.push(g,this.push(d,this.push(e,f)));this.tco_counter[this.tco_counter.length]=0;break;case "argument":c=c[1];f=this.push(a,f);break;case "shift":h=c[1];c=c[2];g=this.index(f,h);f=this.shift_args(h,g,f);break;case "tco_hinted_apply":this.tco_counter[this.tco_counter.length-1]++;c=["apply"].concat(_.rest(c));
break;case "apply":k=a;this.call_stack.push(this.last_refer);g=this.index(f,-1);if(k instanceof Array){a=k;c=k[0];k=k[k.length-1];if(k>=0){d=BiwaScheme.nil;for(h=g;--h>=k;)d=new BiwaScheme.Pair(this.index(f,h),d);if(k>=g){for(h=-1;h<g;h++)this.index_set(f,h-1,this.index(f,h));f++;this.index_set(f,-1,this.index(f,-1)+1)}this.index_set(f,k,d)}d=f;e=a}else if(k instanceof Function){c=[];for(h=0;h<g;h++)c.push(this.index(f,h));c=k(c,this);if(c instanceof BiwaScheme.Pause)return a=c,a.set_state(this,["return"],
d,e,f),a.ready(),a;else c instanceof BiwaScheme.Call?(g=["frame",["argument",["constant",1,["argument",["constant",c.after,["apply"]]]]],["return"]],c=["frame",_.inject(c.args,function(a,c){return["constant",c,["argument",a]]},["constant",c.args.length,["argument",["constant",c.proc,["apply",c.args.length]]]]),g]):(a=c,c=["return"])}else throw new BiwaScheme.Error(BiwaScheme.inspect(k)+" is not a function");break;case "return":h=this.index(f,-1);f-=h;c=this.index(f,0);d=this.index(f,1);e=this.index(f,
2);f=f-3-1;_.times(1+this.tco_counter[this.tco_counter.length-1],_.bind(function(){this.call_stack.pop()},this));this.tco_counter.pop();break;default:throw new BiwaScheme.Bug("unknown opecode type: "+c[0]);}return a},evaluate:function(a,c){this.parser=new BiwaScheme.Parser(a);this.compiler=new BiwaScheme.Compiler;if(c)this.after_evaluate=c;BiwaScheme.Debug&&Console.puts("executing: "+a);this.is_top=true;this.file_stack=[];return this.resume(false)},resume:function(a,c,d,e,f,g){for(var h=BiwaScheme.undef;;){if(a)h=
this.execute(c,d,e,f,g),a=false;else{if(!this.parser)break;var k=this.parser.getObject();if(k===BiwaScheme.Parser.EOS)break;k=BiwaScheme.Interpreter.expand(k);h=this.compiler.run(k);h=this.execute(k,h,0,[],0)}if(h instanceof BiwaScheme.Pause)return h}this.after_evaluate(h);return h},invoke_closure:function(a,c){c||(c=[]);for(var d=c.length,e=["constant",d,["argument",["constant",a,["apply"]]]],f=0;f<d;f++)e=["constant",c[f],["argument",e]];return this.execute(a,["frame",e,["halt"]],0,a,0)},compile:function(a){a=
BiwaScheme.Interpreter.read(a);return BiwaScheme.Compiler.compile(a)}});BiwaScheme.Interpreter.read=function(a){a=(new BiwaScheme.Parser(a)).getObject();return a==BiwaScheme.Parser.EOS?BiwaScheme.eof:a};
BiwaScheme.Interpreter.expand=function(a,c){var d=BiwaScheme.Interpreter.expand;c||(c={});var e=null;if(a instanceof BiwaScheme.Pair)switch(a.car){case BiwaScheme.Sym("define"):var e=a.cdr.car,f=a.cdr.cdr,e=new BiwaScheme.Pair(BiwaScheme.Sym("define"),new BiwaScheme.Pair(e,d(f,c)));break;case BiwaScheme.Sym("begin"):e=new BiwaScheme.Pair(BiwaScheme.Sym("begin"),d(a.cdr,c));break;case BiwaScheme.Sym("quote"):e=a;break;case BiwaScheme.Sym("lambda"):e=a.cdr.car;f=a.cdr.cdr;e=new BiwaScheme.Pair(BiwaScheme.Sym("lambda"),
new BiwaScheme.Pair(e,d(f,c)));break;case BiwaScheme.Sym("if"):var e=a.second(),f=a.third(),g=a.fourth();if(g==BiwaScheme.inner_of_nil)g=BiwaScheme.undef;e=BiwaScheme.List(BiwaScheme.Sym("if"),d(e,c),d(f,c),d(g,c));break;case BiwaScheme.Sym("set!"):e=a.second();a=a.third();e=BiwaScheme.List(BiwaScheme.Sym("set!"),e,d(a,c));break;case BiwaScheme.Sym("call-with-current-continuation"):case BiwaScheme.Sym("call/cc"):a=a.second();e=BiwaScheme.List(BiwaScheme.Sym("call/cc"),d(a,c));break;default:if(e=null,
BiwaScheme.isSymbol(a.car)&&(BiwaScheme.TopEnv[a.car.name]instanceof BiwaScheme.Syntax?e=BiwaScheme.TopEnv[a.car.name]:BiwaScheme.CoreEnv[a.car.name]instanceof BiwaScheme.Syntax&&(e=BiwaScheme.CoreEnv[a.car.name])),e){c.modified=true;for(e=e.transform(a);;)if(e=d(e,f={}),!f.modified)break}else e=d(a.car,c),f=BiwaScheme.array_to_list(_.map(a.cdr.to_array(),function(a){return d(a,c)})),e=new BiwaScheme.Pair(e,f)}else e=a;return e};
BiwaScheme.check_arity=function(a,c,d){var e=arguments.callee.caller?arguments.callee.caller.fname:"(?)";if(a<c)if(d&&d==c)throw new BiwaScheme.Error(e+": wrong number of arguments (expected: "+c+" got: "+a+")");else throw new BiwaScheme.Error(e+": too few arguments (at least: "+c+" got: "+a+")");else if(d&&d<a)throw new BiwaScheme.Error(e+": too many arguments (at most: "+d+" got: "+a+")");};
BiwaScheme.define_libfunc=function(a,c,d,e){var f=function(a,f){BiwaScheme.check_arity(a.length,c,d);return e(a,f)};e.fname=a;f.fname=a;f.inspect=function(){return this.fname};BiwaScheme.CoreEnv[a]=f};
BiwaScheme.alias_libfunc=function(a,c){if(BiwaScheme.CoreEnv[a])if(_.isArray(c))_.map(c,function(c){BiwaScheme.alias_libfunc(a,c)});else if(_.isString(c))BiwaScheme.CoreEnv[c]=BiwaScheme.CoreEnv[a];else throw new BiwaScheme.Bug("bad alias for library function `"+a+"': "+c.toString());else throw new BiwaScheme.Bug("library function `"+a+"' does not exist, so can't alias it.");};BiwaScheme.define_syntax=function(a,c){var d=new BiwaScheme.Syntax(a,c);BiwaScheme.CoreEnv[a]=d};
BiwaScheme.define_scmfunc=function(a,c,d,e){(new Interpreter).evaluate("(define "+a+" "+e+"\n)")};BiwaScheme.make_assert=function(a){return function(){a.apply(this,[arguments.callee.caller?arguments.callee.caller.fname:""].concat(_.toArray(arguments)))}};BiwaScheme.make_simple_assert=function(a,c,d){return BiwaScheme.make_assert(function(e,f,g){d&&(e=d);option=g?"("+g+")":"";if(!c(f))throw new BiwaScheme.Error(e+option+": "+a+" required, but got "+BiwaScheme.to_write(f));})};
BiwaScheme.assert_number=BiwaScheme.make_simple_assert("number",function(a){return typeof a=="number"||a instanceof BiwaScheme.Complex});BiwaScheme.assert_integer=BiwaScheme.make_simple_assert("integer",function(a){return typeof a=="number"&&a%1==0});BiwaScheme.assert_real=BiwaScheme.make_simple_assert("real number",function(a){return typeof a=="number"});
BiwaScheme.assert_between=BiwaScheme.make_assert(function(a,c,d,e){if(typeof c!="number"||c!=Math.round(c))throw new BiwaScheme.Error(a+": number required, but got "+BiwaScheme.to_write(c));if(c<d||e<c)throw new BiwaScheme.Error(a+": number must be between "+d+" and "+e+", but got "+BiwaScheme.to_write(c));});BiwaScheme.assert_string=BiwaScheme.make_simple_assert("string",_.isString);BiwaScheme.assert_char=BiwaScheme.make_simple_assert("character",BiwaScheme.isChar);
BiwaScheme.assert_symbol=BiwaScheme.make_simple_assert("symbol",BiwaScheme.isSymbol);BiwaScheme.assert_port=BiwaScheme.make_simple_assert("port",BiwaScheme.isPort);BiwaScheme.assert_pair=BiwaScheme.make_simple_assert("pair",BiwaScheme.isPair);BiwaScheme.assert_list=BiwaScheme.make_simple_assert("list",BiwaScheme.isList);BiwaScheme.assert_vector=BiwaScheme.make_simple_assert("vector",BiwaScheme.isVector);BiwaScheme.assert_hashtable=BiwaScheme.make_simple_assert("hashtable",BiwaScheme.isHashtable);
BiwaScheme.assert_mutable_hashtable=BiwaScheme.make_simple_assert("mutable hashtable",BiwaScheme.isMutableHashtable);BiwaScheme.assert_record=BiwaScheme.make_simple_assert("record",BiwaScheme.isRecord);BiwaScheme.assert_record_td=BiwaScheme.make_simple_assert("record type descriptor",BiwaScheme.isRecordTD);BiwaScheme.assert_record_cd=BiwaScheme.make_simple_assert("record constructor descriptor",BiwaScheme.isRecordCD);BiwaScheme.assert_enum_set=BiwaScheme.make_simple_assert("enum_set",BiwaScheme.isEnumSet);
BiwaScheme.assert_function=BiwaScheme.make_simple_assert("JavaScript function",_.isFunction);BiwaScheme.assert_closure=BiwaScheme.make_simple_assert("scheme function",BiwaScheme.isClosure);BiwaScheme.assert_procedure=BiwaScheme.make_simple_assert("scheme/js function",function(a){return BiwaScheme.isClosure(a)||_.isFunction(a)});BiwaScheme.assert_date=BiwaScheme.make_simple_assert("date",function(a){return a instanceof Date});
BiwaScheme.assert=BiwaScheme.make_assert(function(a,c,d,e){if(!c)throw new BiwaScheme.Error((e||a)+": "+d);});typeof BiwaScheme!="object"&&(BiwaScheme={});
with(BiwaScheme){define_syntax("cond",function(a){var c=a.cdr;if(!(c instanceof Pair)||c===nil)throw Error("malformed cond: cond needs list but got "+to_write_ss(c));var d=null;_.each(c.to_array().reverse(),function(a){if(!(a instanceof Pair))throw Error("bad clause in cond: "+to_write_ss(a));if(a.car===Sym("else"))if(d!==null)throw Error("'else' clause of cond followed by more clauses: "+to_write_ss(c));else d=a.cdr===nil?false:a.cdr.cdr===nil?a.cdr.car:new Pair(Sym("begin"),a.cdr);else{var f=a.car;
if(a.cdr===nil)d=List(Sym("or"),f,d);else if(a.cdr.cdr===nil)d=List(Sym("if"),f,a.cdr.car,d);else if(a.cdr.car===Sym("=>")){var f=a.car,a=a.cdr.cdr.car,g=BiwaScheme.gensym();d=List(Sym("let"),List(List(g,f)),List(Sym("if"),f,List(a,g),d))}else d=List(Sym("if"),f,new Pair(Sym("begin"),a.cdr),d)}});return d});define_syntax("case",function(a){var c=BiwaScheme.gensym();if(a.cdr===nil)throw Error("case: at least one clause is required");else if(a.cdr instanceof Pair){var d=a.cdr.car,e=a.cdr.cdr,f=void 0;
_.each(e.to_array().reverse(),function(a){if(a.car===Sym("else"))if(f===void 0)f=new Pair(Sym("begin"),a.cdr);else throw Error("case: 'else' clause followed by more clauses: "+to_write_ss(e));else f=List(Sym("if"),new Pair(Sym("or"),array_to_list(_.map(a.car.to_array(),function(a){return List(Sym("eqv?"),c,List(Sym("quote"),a))}))),new Pair(Sym("begin"),a.cdr),f)});return new Pair(Sym("let1"),new Pair(c,new Pair(d,new Pair(f,nil))))}else throw Error("case: proper list is required");});define_syntax("and",
function(a){if(a.cdr==nil)return true;var a=a.cdr.to_array(),c=a.length-1,d=a[c];for(c-=1;c>=0;c--)d=List(Sym("if"),a[c],d,false);return d});define_syntax("or",function(a){for(var a=a.cdr.to_array(),c=false,d=a.length-1;d>=0;d--)c=List(Sym("if"),a[d],a[d],c);return c});define_syntax("let",function(a){var c=null;if(a.cdr.car instanceof Symbol)c=a.cdr.car,a=a.cdr;var d=a.cdr.car,e=a.cdr.cdr;if(!(d instanceof Pair)&&d!=BiwaScheme.nil)throw Error("let: need a pair for bindings: got "+to_write(d));for(var f=
nil,a=nil;d instanceof Pair;d=d.cdr)f=new Pair(d.car.car,f),a=new Pair(d.car.cdr.car,a);d=null;c?(f=array_to_list(f.to_array().reverse()),a=array_to_list(a.to_array().reverse()),e=new Pair(Sym("lambda"),new Pair(f,e)),a=new Pair(c,a),d=List(Sym("letrec"),new Pair(List(c,e),nil),a)):d=new Pair(new Pair(Sym("lambda"),new Pair(f,e)),a);return d});define_syntax("let*",function(a){var c=a.cdr.car,d=a.cdr.cdr;if(!(c instanceof Pair))throw Error("let*: need a pair for bindings: got "+to_write(c));var e=
null;_.each(c.to_array().reverse(),function(a){e=new Pair(Sym("let"),new Pair(new Pair(a,nil),e==null?d:new Pair(e,nil)))});return e});var expand_letrec_star=function(a){var c=a.cdr.car,a=a.cdr.cdr;if(!(c instanceof Pair))throw Error("letrec*: need a pair for bindings: got "+to_write(c));var d=a;_.each(c.to_array().reverse(),function(a){d=new Pair(new Pair(Sym("set!"),a),d)});var e=nil;_.each(c.to_array().reverse(),function(a){e=new Pair(new Pair(a.car,new Pair(BiwaScheme.undef,nil)),e)});return new Pair(Sym("let"),
new Pair(e,d))};define_syntax("letrec",expand_letrec_star);define_syntax("letrec*",expand_letrec_star);define_syntax("let-values",function(a){var c=a.cdr.cdr,d=null,e=nil,f=nil;_.each(a.cdr.car.to_array().reverse(),function(a){var c=a.cdr.car,d=BiwaScheme.gensym(),c=new Pair(d,new Pair(new Pair(Sym("lambda"),new Pair(nil,new Pair(c,nil))),nil));e=new Pair(c,e);f=new Pair(new Pair(a.car,new Pair(new Pair(d,nil),nil)),f)});a=new Pair(Sym("let*-values"),new Pair(f,c));return d=new Pair(Sym("let"),new Pair(e,
new Pair(a,nil)))});define_syntax("let*-values",function(a){var c=a.cdr.cdr,d=null;_.each(a.cdr.car.to_array().reverse(),function(a){var f=a.car,a=a.cdr.car;d=new Pair(Sym("call-with-values"),new Pair(new Pair(Sym("lambda"),new Pair(nil,new Pair(a,nil))),new Pair(new Pair(Sym("lambda"),new Pair(f,d==null?c:new Pair(d,nil))),nil)))});return d});BiwaScheme.eq=function(a,c){return a===c};BiwaScheme.eqv=function(a,c){return a==c&&typeof a==typeof c};define_libfunc("eqv?",2,2,function(a){return BiwaScheme.eqv(a[0],
a[1])});define_libfunc("eq?",2,2,function(a){return BiwaScheme.eq(a[0],a[1])});define_libfunc("equal?",2,2,function(a){return to_write(a[0])==to_write(a[1])});define_libfunc("procedure?",1,1,function(a){return a[0]instanceof Array&&a[0].closure_p===true||typeof a[0]=="function"});define_libfunc("number?",1,1,function(a){return typeof a[0]=="number"||a[0]instanceof Complex||a[0]instanceof Rational});define_libfunc("complex?",1,1,function(a){return a[0]instanceof Complex});define_libfunc("real?",1,
1,function(a){return typeof a[0]=="number"});define_libfunc("rational?",1,1,function(a){return a[0]instanceof Rational});define_libfunc("integer?",1,1,function(a){return typeof a[0]=="number"&&a[0]==Math.round(a[0])&&a[0]!=Infinity&&a[0]!=-Infinity});define_libfunc("=",2,null,function(a){var c=a[0];assert_number(a[0]);for(var d=1;d<a.length;d++)if(assert_number(a[d]),a[d]!=c)return false;return true});define_libfunc("<",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++)if(assert_number(a[c]),
!(a[c-1]<a[c]))return false;return true});define_libfunc(">",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++)if(assert_number(a[c]),!(a[c-1]>a[c]))return false;return true});define_libfunc("<=",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++)if(assert_number(a[c]),!(a[c-1]<=a[c]))return false;return true});define_libfunc(">=",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++)if(assert_number(a[c]),!(a[c-1]>=a[c]))return false;return true});define_libfunc("zero?",
1,1,function(a){assert_number(a[0]);return a[0]===0});define_libfunc("positive?",1,1,function(a){assert_number(a[0]);return a[0]>0});define_libfunc("negative?",1,1,function(a){assert_number(a[0]);return a[0]<0});define_libfunc("odd?",1,1,function(a){assert_number(a[0]);return a[0]%2==1||a[0]%2==-1});define_libfunc("even?",1,1,function(a){assert_number(a[0]);return a[0]%2==0});define_libfunc("finite?",1,1,function(a){assert_number(a[0]);return a[0]!=Infinity&&a[0]!=-Infinity&&!isNaN(a[0])});define_libfunc("infinite?",
1,1,function(a){assert_number(a[0]);return a[0]==Infinity||a[0]==-Infinity});define_libfunc("nan?",1,1,function(a){assert_number(a[0]);return isNaN(a[0])});define_libfunc("max",2,null,function(a){for(var c=0;c<a.length;c++)assert_number(a[c]);return Math.max.apply(null,a)});define_libfunc("min",2,null,function(a){for(var c=0;c<a.length;c++)assert_number(a[c]);return Math.min.apply(null,a)});define_libfunc("+",0,null,function(a){for(var c=0,d=0;d<a.length;d++)assert_number(a[d]),c+=a[d];return c});
define_libfunc("*",0,null,function(a){for(var c=1,d=0;d<a.length;d++)assert_number(a[d]),c*=a[d];return c});define_libfunc("-",1,null,function(a){var c=a.length;assert_number(a[0]);if(c==1)return-a[0];else{for(var d=a[0],e=1;e<c;e++)assert_number(a[e]),d-=a[e];return d}});define_libfunc("/",1,null,function(a){var c=a.length;assert_number(a[0]);if(c==1)return 1/a[0];else{for(var d=a[0],e=1;e<c;e++)assert_number(a[e]),d/=a[e];return d}});define_libfunc("abs",1,1,function(a){assert_number(a[0]);return Math.abs(a[0])});
var div=function(a,c){return Math.floor(a/c)},mod=function(a,c){return a-Math.floor(a/c)*c},div0=function(a,c){return a>0?Math.floor(a/c):Math.ceil(a/c)},mod0=function(a,c){return a>0?a-Math.floor(a/c)*c:a-Math.ceil(a/c)*c};define_libfunc("div0-and-mod0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return new Values([div(a[0],a[1]),mod(a[0],a[1])])});define_libfunc("div",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return div(a[0],a[1])});define_libfunc("mod",2,2,function(a){assert_number(a[0]);
assert_number(a[1]);return mod(a[0],a[1])});define_libfunc("div0-and-mod0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return new Values([div0(a[0],a[1]),mod0(a[0],a[1])])});define_libfunc("div0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return div0(a[0],a[1])});define_libfunc("mod0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return mod0(a[0],a[1])});define_libfunc("numerator",1,1,function(a){assert_number(a[0]);if(a[0]instanceof Rational)return a[0].numerator;
else throw new Bug("todo");});define_libfunc("denominator",1,1,function(a){assert_number(a[0]);if(a[0]instanceof Rational)return a[0].denominator;else throw new Bug("todo");});define_libfunc("floor",1,1,function(a){assert_number(a[0]);return Math.floor(a[0])});define_libfunc("ceiling",1,1,function(a){assert_number(a[0]);return Math.ceil(a[0])});define_libfunc("truncate",1,1,function(a){assert_number(a[0]);return a[0]<0?Math.ceil(a[0]):Math.floor(a[0])});define_libfunc("round",1,1,function(a){assert_number(a[0]);
return Math.round(a[0])});define_libfunc("exp",1,1,function(a){assert_number(a[0]);return Math.exp(a[0])});define_libfunc("log",1,2,function(a){var c=a[0],a=a[1];assert_number(c);return a?(assert_number(a),Math.log(c)/Math.log(b)):Math.log(c)});define_libfunc("sin",1,1,function(a){assert_number(a[0]);return Math.sin(a[0])});define_libfunc("cos",1,1,function(a){assert_number(a[0]);return Math.cos(a[0])});define_libfunc("tan",1,1,function(a){assert_number(a[0]);return Math.tan(a[0])});define_libfunc("asin",
1,1,function(a){assert_number(a[0]);return Math.asin(a[0])});define_libfunc("acos",1,1,function(a){assert_number(a[0]);return Math.acos(a[0])});define_libfunc("atan",1,2,function(a){assert_number(a[0]);return a[1]?(assert_number(a[1]),Math.atan2(a[0],a[1])):Math.atan(a[0])});define_libfunc("sqrt",1,1,function(a){assert_number(a[0]);return Math.sqrt(a[0])});define_libfunc("exact-integer-sqrt",1,1,function(a){assert_number(a[0]);var c=Math.sqrt(a[0]);c-=c%1;return new Values([c,a[0]-c*c])});define_libfunc("expt",
2,2,function(a){assert_number(a[0]);assert_number(a[1]);return Math.pow(a[0],a[1])});define_libfunc("make-rectangular",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return new Complex(a[0],a[1])});define_libfunc("make-polar",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return Complex.from_polar(a[0],a[1])});define_libfunc("real-part",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).real});define_libfunc("imag-part",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).imag});
define_libfunc("magnitude",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).magnitude()});define_libfunc("angle",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).angle()});define_libfunc("number->string",1,3,function(a){var c=a[0],d=a[1];if(a[2])throw new Bug("number->string: precision is not yet implemented");return c.toString(d||10)});define_libfunc("string->number",1,3,function(a){var c=a[0],a=a[1]||10;switch(c){case "+inf.0":return Infinity;case "-inf.0":return-Infinity;
case "+nan.0":return NaN;default:return c.match(/[eE.]/)?parseFloat(c):parseInt(c,a)}});define_libfunc("not",1,1,function(a){return a[0]===false?true:false});define_libfunc("boolean?",1,1,function(a){return a[0]===false||a[0]===true?true:false});define_libfunc("boolean=?",2,null,function(a){for(var c=a.length,d=1;d<c;d++)if(a[d]!=a[0])return false;return true});define_libfunc("pair?",1,1,function(a){return a[0]instanceof Pair?true:false});define_libfunc("cons",2,2,function(a){return new Pair(a[0],
a[1])});define_libfunc("car",1,1,function(a){if(!(a[0]instanceof Pair))throw Error("Attempt to apply car on "+a[0]);return a[0].car});define_libfunc("cdr",1,1,function(a){if(!(a[0]instanceof Pair))throw Error("Attempt to apply cdr on "+a[0]);return a[0].cdr});define_libfunc("set-car!",2,2,function(a){if(!(a[0]instanceof Pair))throw Error("Attempt to apply set-car! on "+a[0]);a[0].car=a[1];return BiwaScheme.undef});define_libfunc("set-cdr!",2,2,function(a){if(!(a[0]instanceof Pair))throw Error("Attempt to apply set-cdr! on "+
a[0]);a[0].cdr=a[1];return BiwaScheme.undef});(function(){var a=function(a,d,e){var f=e;_.each(d,function(d){if(f instanceof Pair)f=d?f.cdr:f.car;else throw Error(a+": attempt to get "+(d?"cdr":"car")+" of "+f);});return f};define_libfunc("caar",1,1,function(c){return a("caar",[0,0],c[0])});define_libfunc("cadr",1,1,function(c){return a("cadr",[1,0],c[0])});define_libfunc("cdar",1,1,function(c){return a("cadr",[0,1],c[0])});define_libfunc("cddr",1,1,function(c){return a("cadr",[1,1],c[0])});define_libfunc("caaar",
1,1,function(c){return a("caaar",[0,0,0],c[0])});define_libfunc("caadr",1,1,function(c){return a("caadr",[1,0,0],c[0])});define_libfunc("cadar",1,1,function(c){return a("cadar",[0,1,0],c[0])});define_libfunc("caddr",1,1,function(c){return a("caddr",[1,1,0],c[0])});define_libfunc("cdaar",1,1,function(c){return a("cdaar",[0,0,1],c[0])});define_libfunc("cdadr",1,1,function(c){return a("cdadr",[1,0,1],c[0])});define_libfunc("cddar",1,1,function(c){return a("cddar",[0,1,1],c[0])});define_libfunc("cdddr",
1,1,function(c){return a("cdddr",[1,1,1],c[0])});define_libfunc("caaaar",1,1,function(c){return a("caaaar",[0,0,0,0],c[0])});define_libfunc("caaadr",1,1,function(c){return a("caaadr",[1,0,0,0],c[0])});define_libfunc("caadar",1,1,function(c){return a("caadar",[0,1,0,0],c[0])});define_libfunc("caaddr",1,1,function(c){return a("caaddr",[1,1,0,0],c[0])});define_libfunc("cadaar",1,1,function(c){return a("cadaar",[0,0,1,0],c[0])});define_libfunc("cadadr",1,1,function(c){return a("cadadr",[1,0,1,0],c[0])});
define_libfunc("caddar",1,1,function(c){return a("caddar",[0,1,1,0],c[0])});define_libfunc("cadddr",1,1,function(c){return a("cadddr",[1,1,1,0],c[0])});define_libfunc("cdaaar",1,1,function(c){return a("cdaaar",[0,0,0,1],c[0])});define_libfunc("cdaadr",1,1,function(c){return a("cdaadr",[1,0,0,1],c[0])});define_libfunc("cdadar",1,1,function(c){return a("cdadar",[0,1,0,1],c[0])});define_libfunc("cdaddr",1,1,function(c){return a("cdaddr",[1,1,0,1],c[0])});define_libfunc("cddaar",1,1,function(c){return a("cddaar",
[0,0,1,1],c[0])});define_libfunc("cddadr",1,1,function(c){return a("cddadr",[1,0,1,1],c[0])});define_libfunc("cdddar",1,1,function(c){return a("cdddar",[0,1,1,1],c[0])});define_libfunc("cddddr",1,1,function(c){return a("cddddr",[1,1,1,1],c[0])})})();define_libfunc("null?",1,1,function(a){return a[0]===nil});define_libfunc("list?",1,1,function(a){for(var c=[],d=a[0];d!=nil;d=d.cdr){if(d==nil)break;if(!(d instanceof Pair))return false;if(_.detect(c,function(a){return a===d.car}))return false;c.push(d.car)}return true});
define_libfunc("list",0,null,function(a){for(var c=nil,d=a.length-1;d>=0;d--)c=new Pair(a[d],c);return c});define_libfunc("length",1,1,function(a){assert_list(a[0]);for(var c=0,a=a[0];a!=nil;a=a.cdr)c++;return c});define_libfunc("append",2,null,function(a){for(var c=a.length,d=a[--c];c--;)_.each(a[c].to_array().reverse(),function(a){d=new Pair(a,d)});return d});define_libfunc("reverse",1,1,function(a){if(a[0]==nil)return nil;assert_pair(a[0]);for(var c=nil,a=a[0];a!=nil;a=a.cdr)c=new Pair(a.car,c);
return c});define_libfunc("list-tail",2,2,function(a){assert_pair(a[0]);assert_integer(a[1]);if(a[1]<0)throw Error("list-tail: index out of range ("+a[1]+")");for(var c=a[0],d=0;d<a[1];d++){if(!(c instanceof Pair))throw Error("list-tail: the list is shorter than "+a[1]);c=c.cdr}return c});define_libfunc("list-ref",2,2,function(a){assert_pair(a[0]);assert_integer(a[1]);if(a[1]<0)throw Error("list-tail: index out of range ("+a[1]+")");for(var c=a[0],d=0;d<a[1];d++){if(!(c instanceof Pair))throw Error("list-ref: the list is shorter than "+
a[1]);c=c.cdr}return c.car});define_libfunc("map",2,null,function(a){var c=a.shift();_.each(a,assert_list);var d=[];return Call.multi_foreach(a,{call:function(a){return new Call(c,_.map(a,function(a){return a.car}))},result:function(a){d.push(a)},finish:function(){return array_to_list(d)}})});define_libfunc("for-each",2,null,function(a){var c=a.shift();_.each(a,assert_list);return Call.multi_foreach(a,{call:function(a){return new Call(c,_.map(a,function(a){return a.car}))},finish:function(){return BiwaScheme.undef}})});
define_libfunc("symbol?",1,1,function(a){return a[0]instanceof Symbol?true:false});define_libfunc("symbol->string",1,1,function(a){assert_symbol(a[0]);return a[0].name});define_libfunc("symbol=?",2,null,function(a){assert_symbol(a[0]);for(var c=1;c<a.length;c++)if(assert_symbol(a[c]),a[c]!=a[0])return false;return true});define_libfunc("string->symbol",1,1,function(a){assert_string(a[0]);return Sym(a[0])});define_libfunc("char?",1,1,function(a){return a[0]instanceof Char});define_libfunc("char->integer",
1,1,function(a){assert_char(a[0]);return a[0].value.charCodeAt(0)});define_libfunc("integer->char",1,1,function(a){assert_integer(a[0]);return Char.get(String.fromCharCode(a[0]))});var make_char_compare_func=function(a){return function(c){assert_char(c[0]);for(var d=1;d<c.length;d++)if(assert_char(c[d]),!a(c[d-1].value,c[d].value))return false;return true}};define_libfunc("char=?",2,null,make_char_compare_func(function(a,c){return a==c}));define_libfunc("char<?",2,null,make_char_compare_func(function(a,
c){return a<c}));define_libfunc("char>?",2,null,make_char_compare_func(function(a,c){return a>c}));define_libfunc("char<=?",2,null,make_char_compare_func(function(a,c){return a<=c}));define_libfunc("char>=?",2,null,make_char_compare_func(function(a,c){return a>=c}));define_libfunc("string?",1,1,function(a){return typeof a[0]=="string"});define_libfunc("make-string",1,2,function(a){assert_integer(a[0]);var c=" ";if(a[1])assert_char(a[1]),c=a[1].value;var d="";_.times(a[0],function(){d+=c});return d});
define_libfunc("string",1,null,function(a){for(var c=0;c<a.length;c++)assert_char(a[c]);return _.map(a,function(a){return a.value}).join("")});define_libfunc("string-length",1,1,function(a){assert_string(a[0]);return a[0].length});define_libfunc("string-ref",2,2,function(a){assert_string(a[0]);assert_between(a[1],0,a[0].length-1);return Char.get(a[0].charAt([a[1]]))});define_libfunc("string=?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++)if(assert_string(a[c]),a[0]!=a[c])return false;
return true});define_libfunc("string<?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++)if(assert_string(a[c]),!(a[c-1]<a[c]))return false;return true});define_libfunc("string>?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++)if(assert_string(a[c]),!(a[c-1]>a[c]))return false;return true});define_libfunc("string<=?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++)if(assert_string(a[c]),!(a[c-1]<=a[c]))return false;return true});define_libfunc("string>=?",
2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++)if(assert_string(a[c]),!(a[c-1]>=a[c]))return false;return true});define_libfunc("substring",3,3,function(a){assert_string(a[0]);assert_integer(a[1]);assert_integer(a[2]);if(a[1]<0)throw Error("substring: start too small: "+a[1]);if(a[2]<0)throw Error("substring: end too small: "+a[2]);if(a[0].length+1<=a[1])throw Error("substring: start too big: "+a[1]);if(a[0].length+1<=a[2])throw Error("substring: end too big: "+a[2]);if(!(a[1]<=
a[2]))throw Error("substring: not start <= end: "+a[1]+", "+a[2]);return a[0].substring(a[1],a[2])});define_libfunc("string-append",0,null,function(a){for(var c=0;c<a.length;c++)assert_string(a[c]);return a.join("")});define_libfunc("string->list",1,1,function(a){assert_string(a[0]);return array_to_list(_.map(a[0].split(""),function(a){return Char.get(a[0])}))});define_libfunc("list->string",1,1,function(a){assert_list(a[0]);return _.map(a[0].to_array(),function(a){return a.value}).join("")});define_libfunc("string-for-each",
2,null,function(a){var c=a.shift();_.each(a,assert_string);return Call.multi_foreach(a,{call:function(a){return new Call(c,a)},finish:function(){return BiwaScheme.undef}})});define_libfunc("string-copy",1,1,function(a){assert_string(a[0]);return a[0]});define_libfunc("vector?",1,1,function(a){return a[0]instanceof Array&&a[0].closure_p!==true});define_libfunc("make-vector",1,2,function(a){assert_integer(a[0]);var c=Array(a[0]);if(a.length==2)for(var d=0;d<a[0];d++)c[d]=a[1];return c});define_libfunc("vector",
1,null,function(a){return a});define_libfunc("vector-length",1,1,function(a){assert_vector(a[0]);return a[0].length});define_libfunc("vector-ref",2,2,function(a){assert_vector(a[0]);assert_integer(a[1]);assert_between(a[1],0,a[0].length-1);return a[0][a[1]]});define_libfunc("vector-set!",3,3,function(a){assert_vector(a[0]);assert_integer(a[1]);a[0][a[1]]=a[2];return BiwaScheme.undef});define_libfunc("vector->list",1,1,function(a){assert_vector(a[0]);return array_to_list(a[0])});define_libfunc("list->vector",
1,1,function(a){assert_list(a[0]);return a[0].to_array()});define_libfunc("vector-fill!",2,2,function(a){assert_vector(a[0]);for(var c=a[0],a=a[1],d=0;d<c.length;d++)c[d]=a;return c});define_libfunc("vector-map",2,null,function(a){var c=a.shift();_.each(a,assert_vector);var d=[];return Call.multi_foreach(a,{call:function(a){return new Call(c,a)},result:function(a){d.push(a)},finish:function(){return d}})});define_libfunc("vector-for-each",2,null,function(a){var c=a.shift();_.each(a,assert_vector);
return Call.multi_foreach(a,{call:function(a){return new Call(c,a)},finish:function(){return BiwaScheme.undef}})});define_libfunc("apply",2,null,function(a){var c=a.shift(),d=a.pop(),a=a.concat(d.to_array());return new Call(c,a)});define_syntax("call-with-current-continuation",function(a){return new Pair(Sym("call/cc"),a.cdr)});define_libfunc("values",0,null,function(a){return a.length==1?a[0]:new Values(a)});define_libfunc("call-with-values",2,2,function(a){var c=a[0],d=a[1];assert_procedure(c);
assert_procedure(d);return new Call(c,[],function(a){a=a[0];return a instanceof Values?new Call(d,a.content):new Call(d,[a])})});var expand_qq=function(a,c){if(a instanceof Symbol||a===nil)return List(Sym("quote"),a);else if(a instanceof Pair){var d=a.car;return d instanceof Pair&&d.car===Sym("unquote-splicing")?(c-=1,c==0?List(Sym("append"),a.car.cdr.car,expand_qq(a.cdr,c+1)):List(Sym("cons"),List(Sym("list"),Sym("unquote-splicing"),expand_qq(a.car.cdr.car,c)),expand_qq(a.cdr,c+1))):d===Sym("unquote")?
(c-=1,c==0?a.cdr.car:List(Sym("list"),List(Sym("quote"),Sym("unquote")),expand_qq(a.cdr.car,c))):d===Sym("quasiquote")?List(Sym("list"),Sym("quasiquote"),expand_qq(a.cdr.car,c+1)):List(Sym("cons"),expand_qq(a.car,c),expand_qq(a.cdr,c))}else if(a instanceof Array)throw new Bug("vector quasiquotation is not implemented yet");else return a};define_syntax("quasiquote",function(a){return expand_qq(a.cdr.car,1)});define_syntax("unquote",function(){throw Error("unquote(,) must be inside quasiquote(`)");
});define_syntax("unquote-splicing",function(){throw Error("unquote-splicing(,@) must be inside quasiquote(`)");});define_libfunc("string-upcase",1,1,function(a){assert_string(a[0]);return a[0].toUpperCase()});define_libfunc("string-downcase",1,1,function(a){assert_string(a[0]);return a[0].toLowerCase()});BiwaScheme.make_string_ci_function=function(a){return function(c){assert_string(c[0]);for(var d=c[0].toUpperCase(),e=1;e<c.length;e++)if(assert_string(c[e]),!a(d,c[e].toUpperCase()))return false;
return true}};define_libfunc("string-ci=?",2,null,make_string_ci_function(function(a,c){return a==c}));define_libfunc("string-ci<?",2,null,make_string_ci_function(function(a,c){return a<c}));define_libfunc("string-ci>?",2,null,make_string_ci_function(function(a,c){return a>c}));define_libfunc("string-ci<=?",2,null,make_string_ci_function(function(a,c){return a<=c}));define_libfunc("string-ci>=?",2,null,make_string_ci_function(function(a,c){return a>=c}));define_libfunc("find",2,2,function(a){var c=
a[0],a=a[1];assert_list(a);return Call.foreach(a,{call:function(a){return new Call(c,[a.car])},result:function(a,c){if(a)return c.car},finish:function(){return false}})});define_libfunc("for-all",2,null,function(a){var c=a.shift();_.each(a,assert_list);var d=true;return Call.multi_foreach(a,{call:function(a){return new Call(c,_.map(a,function(a){return a.car}))},result:function(a){if(a===false)return false;d=a},finish:function(){return d}})});define_libfunc("exists",2,null,function(a){var c=a.shift();
_.each(a,assert_list);return Call.multi_foreach(a,{call:function(a){return new Call(c,_.map(a,function(a){return a.car}))},result:function(a){if(a!==false)return a},finish:function(){return false}})});define_libfunc("filter",2,2,function(a){var c=a[0],a=a[1];assert_list(a);var d=[];return Call.foreach(a,{call:function(a){return new Call(c,[a.car])},result:function(a,c){a&&d.push(c.car)},finish:function(){return array_to_list(d)}})});define_libfunc("partition",2,2,function(a){var c=a[0],a=a[1];assert_list(a);
var d=[],e=[];return Call.foreach(a,{call:function(a){return new Call(c,[a.car])},result:function(a,c){a?d.push(c.car):e.push(c.car)},finish:function(){return new Values([array_to_list(d),array_to_list(e)])}})});define_libfunc("fold-left",3,null,function(a){var c=a.shift(),d=a.shift();_.each(a,assert_list);return Call.multi_foreach(a,{call:function(a){a=_.map(a,function(a){return a.car});a.unshift(d);return new Call(c,a)},result:function(a){d=a},finish:function(){return d}})});define_libfunc("fold-right",
3,null,function(a){var c=a.shift(),d=a.shift(),a=_.map(a,function(a){assert_list(a);return array_to_list(a.to_array().reverse())});return Call.multi_foreach(a,{call:function(a){a=_.map(a,function(a){return a.car});a.push(d);return new Call(c,a)},result:function(a){d=a},finish:function(){return d}})});define_libfunc("remp",2,2,function(a){var c=a[0],a=a[1];assert_list(a);var d=[];return Call.foreach(a,{call:function(a){return new Call(c,[a.car])},result:function(a,c){a||d.push(c.car)},finish:function(){return array_to_list(d)}})});
var make_remover=function(a){return function(c){var d=c[0],c=c[1];assert_list(c);var e=[];return Call.foreach(c,{call:function(c){return new Call(TopEnv[a]||CoreEnv[a],[d,c.car])},result:function(a,c){a||e.push(c.car)},finish:function(){return array_to_list(e)}})}};define_libfunc("remove",2,2,make_remover("equal?"));define_libfunc("remv",2,2,make_remover("eqv?"));define_libfunc("remq",2,2,make_remover("eq?"));define_libfunc("memp",2,2,function(a){var c=a[0],a=a[1];assert_list(a);return Call.foreach(a,
{call:function(a){return new Call(c,[a.car])},result:function(a,c){if(a)return c},finish:function(){return false}})});var make_finder=function(a){return function(c){var d=c[0],c=c[1];assert_list(c);return Call.foreach(c,{call:function(c){return new Call(TopEnv[a]||CoreEnv[a],[d,c.car])},result:function(a,c){if(a)return c},finish:function(){return false}})}};define_libfunc("member",2,2,make_finder("equal?"));define_libfunc("memv",2,2,make_finder("eqv?"));define_libfunc("memq",2,2,make_finder("eq?"));
define_libfunc("assp",2,2,function(a){var c=a[0],a=a[1];assert_list(a);return Call.foreach(a,{call:function(a){if(a.car.car)return new Call(c,[a.car.car]);else throw Error("ass*: pair required but got "+to_write(a.car));},result:function(a,c){if(a)return c.car},finish:function(){return false}})});var make_assoc=function(a,c){return function(d){var e=d[0],d=d[1];assert_list(d);return Call.foreach(d,{call:function(d){if(!BiwaScheme.isPair(d.car))throw Error(a+": pair required but got "+to_write(d.car));
return new Call(TopEnv[c]||CoreEnv[c],[e,d.car.car])},result:function(a,c){if(a)return c.car},finish:function(){return false}})}};define_libfunc("assoc",2,2,make_assoc("assoc","equal?"));define_libfunc("assv",2,2,make_assoc("assv","eqv?"));define_libfunc("assq",2,2,make_assoc("assq","eq?"));define_libfunc("cons*",1,null,function(a){if(a.length==1)return a[0];else{var c=null;_.each(a.reverse(),function(a){c=c?new Pair(a,c):a});return c}});define_libfunc("list-sort",1,2,function(a){if(a[1])throw new Bug("list-sort: cannot take compare proc now");
assert_list(a[0]);return array_to_list(a[0].to_array().sort())});define_libfunc("vector-sort",1,2,function(a){if(a[1])throw new Bug("vector-sort: cannot take compare proc now");assert_vector(a[0]);return _.clone(a[0]).sort()});define_libfunc("vector-sort!",1,2,function(a){if(a[1])throw new Bug("vector-sort!: cannot take compare proc now");assert_vector(a[0]);a[0].sort();return BiwaScheme.undef});define_syntax("when",function(a){var c=a.cdr.car,a=a.cdr.cdr;return new Pair(Sym("if"),new Pair(c,new Pair(new Pair(Sym("begin"),
a),new Pair(BiwaScheme.undef,nil))))});define_syntax("unless",function(a){var c=a.cdr.car,a=a.cdr.cdr;return new Pair(Sym("if"),new Pair(new Pair(Sym("not"),new Pair(c,nil)),new Pair(new Pair(Sym("begin"),a),new Pair(BiwaScheme.undef,nil))))});define_syntax("do",function(a){if(!BiwaScheme.isPair(a.cdr))throw Error("do: no variables of do");var c=a.cdr.car;if(!BiwaScheme.isPair(c))throw Error("do: variables must be given as a list");if(!BiwaScheme.isPair(a.cdr.cdr))throw Error("do: no resulting form of do");
var d=a.cdr.cdr.car,e=a.cdr.cdr.cdr,a=BiwaScheme.gensym(),f=array_to_list(c.map(function(a){a=a.to_array();return List(a[0],a[1])})),g=d.car,d=new Pair(Sym("begin"),d.cdr),c=new Pair(a,array_to_list(c.map(function(a){a=a.to_array();return a[2]||a[0]}))),c=(new Pair(Sym("begin"),e)).concat(List(c));return List(Sym("let"),a,f,List(Sym("if"),g,d,c))});define_syntax("case-lambda",function(){});define_syntax("define-record-type",function(a){var c=a.cdr.car,d=a.cdr.cdr;if(BiwaScheme.isSymbol(c))var e=c,
a=Sym("make-"+c.name),c=Sym(c.name+"?");else assert_list(c),e=c.car,a=c.cdr.car,c=c.cdr.cdr.car,assert_symbol(e),assert_symbol(a),assert_symbol(c);var f=false,g=false,h=false,k,o=false,t=false,y=false,u=[];_.each(d.to_array(),function(a){switch(a.car){case Sym("fields"):u=_.map(a.cdr.to_array(),function(a,c){if(BiwaScheme.isSymbol(a))return{name:a,idx:c,mutable:false,accessor_name:null,mutator_name:null};else switch(assert_list(a),assert_symbol(a.car),a.car){case Sym("immutable"):var d=a.cdr.car;
assert_symbol(d);return BiwaScheme.isNil(a.cdr.cdr)?{name:d,idx:c,mutable:false}:{name:d,idx:c,mutable:false,accessor_name:a.cdr.cdr.car};case Sym("mutable"):return d=a.cdr.car,assert_symbol(d),BiwaScheme.isNil(a.cdr.cdr)?{name:d,idx:c,mutable:true}:{name:d,idx:c,mutable:true,accessor_name:a.cdr.cdr.car,mutator_name:a.cdr.cdr.cdr.car};default:throw Error("define-record-type: field definition must start with `immutable' or `mutable' but got "+BiwaScheme.inspect(a.car));}});break;case Sym("parent"):k=
a.cdr.car;assert_symbol(k);break;case Sym("protocol"):y=a.cdr.car;break;case Sym("sealed"):f=!!a.cdr.car;break;case Sym("opaque"):g=!!a.cdr.car;break;case Sym("nongenerative"):h=a.cdr.car;break;case Sym("parent-rtd"):o=a.cdr.car;t=a.cdr.cdr.car;break;default:throw new BiwaScheme.Error("define-record-type: unknown clause `"+BiwaScheme.to_write(a.car)+"'");}});k&&(o=[Sym("record-type-descriptor"),k],t=[Sym("record-constructor-descriptor"),k]);var l=[Sym("record-type-descriptor"),e],d=[Sym("record-constructor-descriptor"),
e],r=_.map(u,function(a){return List(Sym(a.mutable?"mutable":"immutable"),a.name)});r.is_vector=true;var r=[Sym("make-record-type-descriptor"),[Sym("quote"),e],o,h,f,g,r],s=[Sym("make-record-constructor-descriptor"),Sym("__rtd"),t,y],r=[Sym("let*"),[[Sym("__rtd"),r],[Sym("__cd"),s]],[Sym("_define-record-type"),[Sym("quote"),e],Sym("__rtd"),Sym("__cd")]],s=_.map(u,function(a){var c=a.accessor_name||Sym(e.name+"-"+a.name.name);return[Sym("define"),c,[Sym("record-accessor"),l,a.idx]]}),p=_.filter(u,
function(a){return a.mutable}),p=_.map(p,function(a){var c=a.mutator_name||Sym(e.name+"-"+a.name.name+"-set!");return[Sym("define"),c,[Sym("record-mutator"),l,a.idx]]});return deep_array_to_list([Sym("begin"),r,[Sym("define"),a,[Sym("record-constructor"),d]],[Sym("define"),c,[Sym("record-predicate"),l]]].concat(s).concat(p))});define_libfunc("_define-record-type",3,3,function(a){assert_symbol(a[0]);assert_record_td(a[1]);assert_record_cd(a[2]);BiwaScheme.Record.define_type(a[0].name,a[1],a[2]);return BiwaScheme.undef});
define_syntax("record-type-descriptor",function(a){return deep_array_to_list([Sym("_record-type-descriptor"),[Sym("quote"),a.cdr.car]])});define_libfunc("_record-type-descriptor",1,1,function(a){assert_symbol(a[0]);var c=BiwaScheme.Record.get_type(a[0].name);if(c)return c.rtd;else throw Error("record-type-descriptor: unknown record type "+a[0].name);});define_syntax("record-constructor-descriptor",function(a){return deep_array_to_list([Sym("_record-constructor-descriptor"),[Sym("quote"),a.cdr.car]])});
define_libfunc("_record-constructor-descriptor",1,1,function(a){assert_symbol(a[0]);var c=BiwaScheme.Record.get_type(a[0].name);if(c)return c.cd;else throw Error("record-constructor-descriptor: unknown record type "+a[0].name);});define_libfunc("make-record-type-descriptor",6,6,function(a){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],a=a[5];assert_symbol(c);d&&assert_record_td(d);if(e){assert_symbol(e);var h=BiwaScheme.Record.RTD.NongenerativeRecords[e.name];if(h)return h}f=!!f;g=!!g;assert_vector(a);for(h=
0;h<a.length;h++){var k=a[h];assert_symbol(k.car,"mutability");assert_symbol(k.cdr.car,"field name");a[h]=[k.cdr.car.name,k.car==Sym("mutable")]}c=new BiwaScheme.Record.RTD(c,d,e,f,g,a);e&&(BiwaScheme.Record.RTD.NongenerativeRecords[e.name]=c);return c});define_libfunc("record-type-descriptor?",1,1,function(a){return a[0]instanceof BiwaScheme.Record.RTD});define_libfunc("make-record-constructor-descriptor",3,3,function(a){var c=a[0],d=a[1],a=a[2];assert_record_td(c);d&&assert_record_cd(d);a&&assert_procedure(a);
return new BiwaScheme.Record.CD(c,d,a)});define_libfunc("record-constructor",1,1,function(a){a=a[0];assert_record_cd(a);return a.record_constructor()});define_libfunc("record-predicate",1,1,function(a){var c=a[0];assert_record_td(c);return function(a){a=a[0];return a instanceof BiwaScheme.Record&&a.rtd===c}});define_libfunc("record-accessor",2,2,function(a){var c=a[0],d=a[1];assert_record_td(c);assert_integer(d);for(a=c.parent_rtd;a;a=a.parent_rtd)d+=a.fields.length;return function(a){var a=a[0],
f=c.name.name+"-"+c.field_name(d)+": "+BiwaScheme.to_write(a)+" is not a "+c.name.name;assert(BiwaScheme.isRecord(a),f);for(var g=false,h=a.rtd;h;h=h.parent_rtd)h==c&&(g=true);assert(g,f);return a.get(d)}});define_libfunc("record-mutator",2,2,function(a){var c=a[0],d=a[1];assert_record_td(c);assert_integer(d);for(a=c.parent_rtd;a;a=a.parent_rtd)d+=a.fields.length;return function(a){var f=a[0],a=a[1],g=c.field_name(d);assert_record(f);assert(f.rtd===c,g+": "+BiwaScheme.to_write(f)+" is not a "+c.name.name);
assert(!f.rtd.sealed,g+": "+c.name.name+" is sealed (can't mutate)");f.set(d,a)}});define_libfunc("record?",1,1,function(a){a=a[0];return BiwaScheme.isRecord(a)?a.rtd.opaque?false:true:false});define_libfunc("record-rtd",1,1,function(a){assert_record(a[0]);return a[0].rtd});define_libfunc("record-type-name",1,1,function(a){assert_record_td(a[0]);return a[0].name});define_libfunc("record-type-parent",1,1,function(a){assert_record_td(a[0]);return a[0].parent_rtd});define_libfunc("record-type-uid",1,
1,function(a){assert_record_td(a[0]);return a[0].uid});define_libfunc("record-type-generative?",1,1,function(a){assert_record_td(a[0]);return a[0].generative});define_libfunc("record-type-sealed?",1,1,function(a){assert_record_td(a[0]);return a[0].sealed});define_libfunc("record-type-opaque?",1,1,function(a){assert_record_td(a[0]);return a[0].opaque});define_libfunc("record-type-field-names",1,1,function(a){assert_record_td(a[0]);return _.map(a[0].fields,function(a){return a.name})});define_libfunc("record-field-mutable?",
2,2,function(a){var c=a[0],d=a[1];assert_record_td(a[0]);assert_integer(d);for(c=c.parent_rtd;c;c=c.parent_rtd)d+=c.fields.length;return a[0].fields[d].mutable});define_libfunc("raise",1,1,function(a){throw new BiwaScheme.UserError(BiwaScheme.to_write(a[0]));});define_libfunc("port?",1,1,function(a){return a[0]instanceof Port});define_libfunc("textual-port?",1,1,function(a){assert_port(a[0]);return!a[0].is_binary});define_libfunc("binary-port?",1,1,function(a){assert_port(a[0]);return a[0].is_binary});
define_libfunc("close-port",1,1,function(a){assert_port(a[0]);a[0].close();return BiwaScheme.undef});define_libfunc("call-with-port",2,2,function(a){var c=a[0],a=a[1];assert_port(c);assert_closure(a);return new Call(a,[c],function(a){c.close();return a[0]})});define_libfunc("call-with-string-output-port",1,1,function(a){a=a[0];assert_procedure(a);var c=new BiwaScheme.Port.StringOutput;return new Call(a,[c],function(){c.close();return c.output_string()})});define_libfunc("put-char",2,2,function(a){assert_port(a[0]);
assert_char(a[1]);a[0].put_string(a[1].value);return BiwaScheme.undef});define_libfunc("put-string",2,2,function(a){assert_port(a[0]);assert_string(a[1]);a[0].put_string(a[1]);return BiwaScheme.undef});define_libfunc("put-datum",2,2,function(a){assert_port(a[0]);a[0].put_string(to_write(a[1]));return BiwaScheme.undef});define_libfunc("eof-object",0,0,function(){return eof});define_libfunc("eof-object?",1,1,function(a){return a[0]===eof});define_libfunc("input-port?",1,1,function(a){assert_port(a[0]);
return a[0].is_input});define_libfunc("output-port?",1,1,function(a){assert_port(a[0]);return a[0].is_output});define_libfunc("current-input-port",0,0,function(){return Port.current_input});define_libfunc("current-output-port",0,0,function(){return Port.current_output});define_libfunc("current-error-port",0,0,function(){return Port.current_error});define_libfunc("close-input-port",1,1,function(a){assert_port(a[0]);if(!a[0].is_input)throw Error("close-input-port: port is not input port");a[0].close();
return BiwaScheme.undef});define_libfunc("close-output-port",1,1,function(a){assert_port(a[0]);if(!a[0].is_output)throw Error("close-output-port: port is not output port");a[0].close();return BiwaScheme.undef});define_libfunc("read",0,1,function(a){a=a[0]||Port.current_input;assert_port(a);return a.get_string(function(a){return Interpreter.read(a)})});define_libfunc("write-char",1,2,function(a){var c=a[1]||Port.current_output;assert_char(a[0]);c.put_string(a[0].value);return BiwaScheme.undef});define_libfunc("newline",
0,1,function(a){(a[0]||Port.current_output).put_string("\n");return BiwaScheme.undef});define_libfunc("display",1,2,function(a){(a[1]||Port.current_output).put_string(to_display(a[0]));return BiwaScheme.undef});define_libfunc("write",1,2,function(a){var c=a[1]||Port.current_output;assert_port(c);c.put_string(to_write(a[0]));return BiwaScheme.undef});define_libfunc("bitwise-not",1,1,function(a){return~a[0]});define_libfunc("bitwise-and",1,null,function(a){return _.reduce(a,function(a,d){return a&d})});
define_libfunc("bitwise-ior",1,null,function(a){return _.reduce(a,function(a,d){return a|d})});define_libfunc("bitwise-xor",1,null,function(a){return _.reduce(a,function(a,d){return a^d})});define_libfunc("bitwise-if",3,3,function(a){return a[0]&a[1]|~a[0]&a[2]});define_libfunc("bitwise-bit-count",1,1,function(a){for(var a=Math.abs(a[0]),c=0;a!=0;a>>=1)a&1&&c++;return c});define_libfunc("bitwise-length",1,1,function(a){for(var a=Math.abs(a[0]),c=0;a!=0;a>>=1)c++;return c});define_libfunc("bitwise-first-bit-set",
1,1,function(a){var a=Math.abs(a[0]),c=0;if(a==0)return-1;for(;a!=0;a>>=1){if(a&1)return c;c++}});define_libfunc("bitwise-bit-set?",2,2,function(a){return!!(a[0]&1<<a[1])});define_libfunc("bitwise-copy-bit",3,3,function(a){var c=1<<a[1];return c&a[2]<<a[1]|~c&a[0]});define_libfunc("bitwise-bit-field",3,3,function(a){return(~(-1<<a[2])&a[0])>>a[1]});define_libfunc("bitwise-copy-bit-field",4,4,function(a){var c=a[1],d=~(-1<<a[2])&-1<<c;return d&a[3]<<c|~d&a[0]});define_libfunc("bitwise-arithmetic-shift",
2,2,function(a){return a[1]>=0?a[0]<<a[1]:a[0]>>-a[1]});define_libfunc("bitwise-arithmetic-shift-left",2,2,function(a){return a[0]<<a[1]});define_libfunc("bitwise-arithmetic-shift-right",2,2,function(a){return a[0]>>a[1]});define_libfunc("bitwise-rotate-bit-field",4,4,function(a){var c=a[0],d=a[1],e=a[2],a=a[3],f=e-d;if(f<=0)return c;a%=f;var g=(~(-1<<e)&c)>>d,e=~(-1<<e)&-1<<d;return e&(g<<a|g>>f-a)<<d|~e&c});define_libfunc("bitwise-reverse-bit-field",3,3,function(a){for(var c=n=a[0],d=a[1],a=a[2],
e=(~(-1<<a)&n)>>d,f=0;f<a-d;f++,e>>=1)var g=a-1-f,h=1<<g,c=h&(e&1)<<g|~h&c;return c});define_libfunc("make-eq-hashtable",0,1,function(){return new Hashtable(Hashtable.eq_hash,Hashtable.eq_equiv)});define_libfunc("make-eqv-hashtable",0,1,function(){return new Hashtable(Hashtable.eqv_hash,Hashtable.eqv_equiv)});define_libfunc("make-hashtable",2,3,function(a){assert_procedure(a[0]);assert_procedure(a[1]);return new Hashtable(a[0],a[1])});define_libfunc("hashtable?",1,1,function(a){return a[0]instanceof
Hashtable});define_libfunc("hashtable-size",1,1,function(a){assert_hashtable(a[0]);return a[0].keys().length});BiwaScheme.find_hash_pair=function(a,c,d){return new Call(a.hash_proc,[c],function(e){var f=e[0],e=a.candidate_pairs(f);return!e?d.on_not_found(f):Call.foreach(e,{call:function(d){return new Call(a.equiv_proc,[c,d[0]])},result:function(a,c){if(a)return d.on_found(c,f)},finish:function(){return d.on_not_found(f)}})})};define_libfunc("hashtable-ref",3,3,function(a){var c=a[0],d=a[1],e=a[2];
assert_hashtable(c);return BiwaScheme.find_hash_pair(c,d,{on_found:function(a){return a[1]},on_not_found:function(){return e}})});define_libfunc("hashtable-set!",3,3,function(a){var c=a[0],d=a[1],e=a[2];assert_hashtable(c);assert(c.mutable,"hashtable is not mutable");return BiwaScheme.find_hash_pair(c,d,{on_found:function(a){a[1]=e;return BiwaScheme.undef},on_not_found:function(a){c.add_pair(a,d,e);return BiwaScheme.undef}})});define_libfunc("hashtable-delete!",2,2,function(a){var c=a[0],a=a[1];assert_hashtable(c);
assert(c.mutable,"hashtable is not mutable");return BiwaScheme.find_hash_pair(c,a,{on_found:function(a,e){c.remove_pair(e,a);return BiwaScheme.undef},on_not_found:function(){return BiwaScheme.undef}})});define_libfunc("hashtable-contains?",2,2,function(a){var c=a[0],a=a[1];assert_hashtable(c);return BiwaScheme.find_hash_pair(c,a,{on_found:function(){return true},on_not_found:function(){return false}})});define_libfunc("hashtable-update!",4,4,function(a){var c=a[0],d=a[1],e=a[2],f=a[3];assert_hashtable(c);
assert(c.mutable,"hashtable is not mutable");assert_procedure(e);return BiwaScheme.find_hash_pair(c,d,{on_found:function(a){return new Call(e,[a[1]],function(c){a[1]=c[0];return BiwaScheme.undef})},on_not_found:function(a){return new Call(e,[f],function(e){c.add_pair(a,d,e[0]);return BiwaScheme.undef})}})});define_libfunc("hashtable-copy",1,2,function(a){var c=a[1]===void 0?false:!!a[1];assert_hashtable(a[0]);return a[0].create_copy(c)});define_libfunc("hashtable-clear!",0,1,function(a){assert_hashtable(a[0]);
assert(a[0].mutable,"hashtable is not mutable");a[0].clear();return BiwaScheme.undef});define_libfunc("hashtable-keys",1,1,function(a){assert_hashtable(a[0]);return a[0].keys()});define_libfunc("hashtable-entries",1,1,function(a){assert_hashtable(a[0]);return new Values([a[0].keys(),a[0].values()])});define_libfunc("hashtable-equivalence-function",1,1,function(a){assert_hashtable(a[0]);return a[0].equiv_proc});define_libfunc("hashtable-hash-function",1,1,function(a){assert_hashtable(a[0]);return a[0].hash_proc});
define_libfunc("hashtable-mutable?",1,1,function(a){assert_hashtable(a[0]);return a[0].mutable});define_libfunc("equal-hash",0,0,function(){return Hashtable.equal_hash});define_libfunc("string-hash",0,0,function(){return Hashtable.string_hash});define_libfunc("string-ci-hash",0,0,function(){return Hashtable.string_ci_hash});define_libfunc("symbol-hash",0,0,function(){return Hashtable.symbol_hash});define_libfunc("make-enumeration",1,1,function(a){assert_list(a[0]);a=a[0].to_array();return(new BiwaScheme.Enumeration.EnumType(a)).universe()});
define_libfunc("enum-set-universe",1,1,function(a){assert_enum_set(a[0]);return a[0].enum_type.universe()});define_libfunc("enum-set-indexer",1,1,function(a){assert_enum_set(a[0]);return a[0].enum_type.indexer()});define_libfunc("enum-set-constructor",1,1,function(a){assert_enum_set(a[0]);return a[0].enum_type.constructor()});define_libfunc("enum-set->list",1,1,function(a){assert_enum_set(a[0]);return a[0].symbol_list()});define_libfunc("enum-set-member?",2,2,function(a){assert_symbol(a[0]);assert_enum_set(a[1]);
return a[1].is_member(a[0])});define_libfunc("enum-set-subset?",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);return a[0].is_subset(a[1])});define_libfunc("enum-set=?",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);return a[0].equal_to(a[1])});define_libfunc("enum-set-union",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);assert(a[0].enum_type===a[1].enum_type,"two enum-sets must be the same enum-type","enum-set-union");return a[0].union(a[1])});define_libfunc("enum-set-intersection",
2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);return a[0].intersection(a[1])});define_libfunc("enum-set-difference",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);return a[0].difference(a[1])});define_libfunc("enum-set-complement",1,1,function(a){assert_enum_set(a[0]);return a[0].complement()});define_libfunc("enum-set-projection",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);return a[0].projection(a[1])});define_syntax("define-enumeration",function(a){var c=
a.cdr.car;assert(BiwaScheme.isSymbol(c),"expected symbol for type_name","define-enumeration");var c=c.name,d=a.cdr.cdr.car;assert(BiwaScheme.isList(d),"expected list of symbol for members","define-enumeration");var d=d.to_array(),e=a.cdr.cdr.cdr.car;assert(BiwaScheme.isSymbol(e),"expected symbol for constructor_name","define-enumeration");var e=e.name,f=new BiwaScheme.Enumeration.EnumType(d);define_syntax(c,function(a){assert(!BiwaScheme.isNil(a.cdr),"an argument is needed",c);a=a.cdr.car;assert_symbol(a,
c);assert(_.include(f.members,a),a.name+" is not included in the universe: "+BiwaScheme.to_write(f.members),c);return BiwaScheme.List(Sym("quote"),a)});define_syntax(e,function(a){assert_list(a.cdr,e);a=a.cdr.to_array();_.each(a,function(a){assert_symbol(a,e);assert(_.include(f.members,a),a.name+" is not included in the universe: "+BiwaScheme.to_write(f.members),e)});return new BiwaScheme.Enumeration.EnumSet(f,a)})});define_libfunc("eval",1,1,function(a,c){var d=a[0];return(new Interpreter(c)).evaluate(d.to_write())})}
typeof BiwaScheme!="object"&&(BiwaScheme={});
with(BiwaScheme){define_libfunc("js-eval",1,1,function(a){return eval(a[0])});define_libfunc("js-ref",2,2,function(a){return _.isString(a[1])?a[0][a[1]]:(assert_symbol(a[1]),a[0][a[1].name])});define_libfunc("js-set!",3,3,function(a){assert_string(a[1]);a[0][a[1]]=a[2];return BiwaScheme.undef});define_libfunc("js-call",1,null,function(a){var c=a.shift();assert_function(c);return c.apply(null,a)});define_libfunc("js-invoke",2,null,function(a){var c=a.shift(),d=a.shift();if(!_.isString(d))assert_symbol(d),
d=d.name;if(c[d])return c[d].apply(c,a);else throw Error("js-invoke: function "+d+" is not defined");});define_libfunc("js-invocation",2,null,function(a,c){var d=a.shift();BiwaScheme.isSymbol(d)&&(d=eval(d.name));var e=d;_.each(a,function(a){if(BiwaScheme.isSymbol(a))e=e[a.name];else if(BiwaScheme.isList(a)){a=a.to_array();assert_symbol(a[0]);var d=a.shift().name,a=_.map(a,function(a){if(BiwaScheme.isClosure(a))return BiwaScheme.js_closure(a,c);else if(BiwaScheme.isList(a)){var d={};a.foreach(function(a){assert_symbol(a.car);
d[a.car.name]=a.cdr});return d}else return a});if(!_.isFunction(e[d]))throw new BiwaScheme.Error("js-invocation: the method `"+d+"' not found");e=e[d].apply(e,a)}else throw new BiwaScheme.Error("js-invocation: expected list or symbol for callspec but got "+BiwaScheme.inspect(a));});return e});define_libfunc("js-new",1,null,function(a,c){var d=function(a){if(a.length%2!=0)throw Error("js-new: odd number of key-value pair");for(var d={},e=0;e<a.length;e+=2){var f=a[e],g=a[e+1];assert_symbol(f);g.closure_p===
true&&(g=BiwaScheme.js_closure(g,c));d[f.name]=g}return d},e=a.shift();assert_string(e);if(a.length==0)return eval("new "+e+"()");else{for(var f=[],g=0;g<a.length;g++)if(a[g]instanceof Symbol){f.push(d(a.slice(g)));break}else f.push(a[g]);d=_.map(a,function(a,c){return"args['"+c+"']"}).join(",");return eval("new "+e+"("+d+")")}});define_libfunc("js-obj",0,null,function(a){if(a.length%2!=0)throw Error("js-obj: number of arguments must be even");var c={};for(i=0;i<a.length/2;i++)assert_string(a[i*2]),
c[a[i*2]]=a[i*2+1];return c});BiwaScheme.js_closure=function(a,c){var d=new Interpreter(c);return function(){return d.invoke_closure(a,_.toArray(arguments))}};define_libfunc("js-closure",1,1,function(a,c){assert_closure(a[0]);return BiwaScheme.js_closure(a[0],c)});define_libfunc("js-null?",1,1,function(a){return a[0]===null});define_libfunc("js-undefined?",1,1,function(a){return a[0]===void 0});define_libfunc("js-function?",1,1,function(a){return _.isFunction(a[0])});define_libfunc("js-array-to-list",
1,1,function(a){return BiwaScheme.array_to_list(a[0])});define_libfunc("list-to-js-array",1,1,function(a){return a[0].to_array()});BiwaScheme.alist_to_js_obj=function(a){if(a===nil)return{};assert_list(a);var c={};a.foreach(function(a){assert_string(a.car);c[a.car]=a.cdr});return c};define_libfunc("alist-to-js-obj",1,1,function(a){return BiwaScheme.alist_to_js_obj(a[0])});BiwaScheme.js_obj_to_alist=function(a){if(a===void 0)return BiwaScheme.nil;var c=[];_.each(a,function(a,e){c.push(new Pair(e,a))});
return BiwaScheme.array_to_list(c)};define_libfunc("js-obj-to-alist",1,1,function(a){return BiwaScheme.js_obj_to_alist(a[0])});define_libfunc("timer",2,2,function(a,c){var d=a[0],e=a[1];assert_closure(d);assert_real(e);var f=new Interpreter(c);setTimeout(function(){f.invoke_closure(d)},e*1E3);return BiwaScheme.undef});define_libfunc("set-timer!",2,2,function(a,c){var d=a[0],e=a[1];assert_closure(d);assert_real(e);var f=new Interpreter(c);return setInterval(function(){f.invoke_closure(d)},e*1E3)});
define_libfunc("clear-timer!",1,1,function(a){clearInterval(a[0]);return BiwaScheme.undef});define_libfunc("sleep",1,1,function(a){var c=a[0];assert_real(c);return new BiwaScheme.Pause(function(a){setTimeout(function(){a.resume(nil)},c*1E3)})});var define_console_func=function(a){define_libfunc("console-"+a,1,null,function(c){var d=window.console;if(d){var e=_.map(c,function(a){return BiwaScheme.inspect(a,{fallback:a})});d[a].apply(d,e)}return c[0]})};define_console_func("debug");define_console_func("log");
define_console_func("info");define_console_func("warn");define_console_func("error")}typeof BiwaScheme!="object"&&(BiwaScheme={});
with(BiwaScheme)define_libfunc("read-line",0,1,function(a){a=a[0]||Port.current_input;assert_port(a);return a.get_string()}),define_libfunc("element-empty!",1,1,function(a){return $(a[0]).attr("value")?$(a[0]).val(""):$(a[0]).empty()}),alias_libfunc("element-empty!","element-clear!"),define_libfunc("element-visible?",1,1,function(a){return $(a[0]).is(":visible")}),define_libfunc("element-toggle!",1,1,function(a){return $(a[0]).toggle()}),define_libfunc("element-hide!",1,1,function(a){return $(a[0]).hide()}),
define_libfunc("element-show!",1,1,function(a){return $(a[0]).show()}),define_libfunc("element-remove!",1,1,function(a){return $(a[0]).remove()}),define_libfunc("element-update!",2,2,function(a){return $(a[0]).html(a[1])}),define_libfunc("element-replace!",2,2,function(a){return $(a[0]).replaceWith(a[1])}),define_libfunc("element-insert!",2,2,function(a){return $(a[0]).append(a[1])}),define_libfunc("element-wrap!",3,3,function(){throw new Bug("not yet implemented");}),define_libfunc("element-ancestors",
1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-descendants",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-first-descendant",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-immediate-descendants",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-previous-sibling",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-next-sibling",1,1,function(){throw new Bug("not yet implemented");
}),define_libfunc("element-siblings",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-match?",2,2,function(){throw new Bug("not yet implemented");}),define_libfunc("element-up",3,3,function(){throw new Bug("not yet implemented");}),define_libfunc("element-down",3,3,function(){throw new Bug("not yet implemented");}),define_libfunc("element-previous",3,3,function(){throw new Bug("not yet implemented");}),define_libfunc("element-next",3,3,function(){throw new Bug("not yet implemented");
}),define_libfunc("element-select",1,1,function(a){$(a[0]).select()}),define_libfunc("element-adjacent",0,0,function(){throw new Bug("not yet implemented");}),define_libfunc("element-identify",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-read-attribute",2,2,function(a){assert_string(a[1]);return $(a[0]).attr(a[1])}),define_libfunc("element-write-attribute",3,3,function(a){assert_string(a[1]);return $(a[0]).attr(a[1],a[2])}),define_libfunc("element-height",1,1,function(a){return $(a[0]).height()}),
define_libfunc("element-width",1,1,function(a){return $(a[0]).width()}),define_libfunc("element-class-names",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-has-class-name?",2,2,function(a){assert_string(a[1]);return $(a[0]).hasClass(a[1])}),define_libfunc("element-add-class-name",2,2,function(a){assert_string(a[1]);return $(a[0]).addClass(a[1])}),define_libfunc("element-remove-class-name",2,2,function(a){assert_string(a[1]);return $(a[0]).removeClass(a[1])}),define_libfunc("element-toggle-class-name",
2,2,function(a){assert_string(a[1]);return $(a[0]).toggleClass(a[1])}),define_libfunc("element-clean-whitespace!",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-empty?",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-descendant-of!",2,2,function(){throw new Bug("not yet implemented");}),define_libfunc("scroll-to-element!",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-style",2,2,function(){throw new Bug("not yet implemented");
}),define_libfunc("element-opacity",2,2,function(){throw new Bug("not yet implemented");}),define_libfunc("element-style-set!",2,2,function(){throw new Bug("not yet implemented");}),define_libfunc("element-opacity-set!",2,2,function(){throw new Bug("not yet implemented");}),define_libfunc("element-dimensions",1,1,function(a){return new Values($(a[0]).width(),$(a[0]).height())}),define_libfunc("element-make-positioned!",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-undo-positioned!",
1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-make-clipping!",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-undo-clipping!",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-cumulative-offset",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-positioned-offset",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-absolutize!",1,1,function(){throw new Bug("not yet implemented");
}),define_libfunc("element-relativize!",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-cumulative-scroll-offset",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-offset-parent",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-viewport-offset",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-clone-position!",1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-absolutize!",
1,1,function(){throw new Bug("not yet implemented");}),define_libfunc("element-focus!",1,1,function(a){return $(a[0]).focus()}),BiwaScheme.create_elements_by_string=function(a){var a=a.to_array(),c=a.shift();if(c instanceof Symbol)c=c.name;var d=c.match(/(.*)\.(.*)/);d&&(c=d[1],a.unshift(Sym("class"),d[2]));if(d=c.match(/(.*)\#(.*)/))c=d[1],a.unshift(Sym("id"),d[2]);for(var d=[],e=["<"+c],f=0;f<a.length;f++)a[f]instanceof Symbol?(e.push(" "+a[f].name+'="'+a[f+1]+'"'),f++):a[f]instanceof Pair?d.push(create_elements_by_string(a[f])):
d.push(a[f]);e.push(">");e.push(d.join(""));e.push("</"+c+">");return e.join("")},BiwaScheme.tree_all=function(a,c){return a===nil?true:c(a.car)===false?false:BiwaScheme.tree_all(a.cdr,c)},define_libfunc("element-new",1,1,function(a){return BiwaScheme.tree_all(a[0],function(a){return _.isString(a)||a instanceof Symbol||a instanceof Pair})?$(create_elements_by_string(a[0]))[0]:nil}),BiwaScheme.element_content=function(a){return $(a).attr("value")?$(a).val():_.escape($(a).html())},define_libfunc("element-content",
1,1,function(a){return BiwaScheme.element_content(a[0])}),define_libfunc("load",1,1,function(a,c){var d=a[0];assert_string(d);var e=new Interpreter(c);return new BiwaScheme.Pause(function(a){$.ajax(d,{success:function(c){e.evaluate(c,function(){return a.resume(BiwaScheme.undef)})},error:function(){throw Error("load: network error: failed to load"+d);}})})}),_require=function(a,c,d){a=$("<script/>",{src:a});$("body").append(a);var e=new Function("return !!("+c+")");e()?d():setTimeout(function(){e()?
d():setTimeout(arguments.callee,10)},10)},define_libfunc("js-load",2,2,function(a){var c=a[0],d=a[1];assert_string(c);assert_string(d);return new BiwaScheme.Pause(function(a){_require(c,"window."+d,function(){a.resume(BiwaScheme.undef)})})}),BiwaScheme.getelem=function(a){a.length>1&&a[1]===false&&(a[1]=[]);a=$.apply(this,a);return a.length>0?a:false},define_libfunc("$",1,2,BiwaScheme.getelem),define_libfunc("getelem",1,2,BiwaScheme.getelem),define_libfunc("dom-element",1,1,function(a){return $(a[0])[0]}),
define_libfunc("set-style!",3,3,function(a){assert_string(a[1]);$(a[0]).css(a[1],a[2]);return BiwaScheme.undef}),define_libfunc("get-style",2,2,function(a){assert_string(a[1]);return $(a[0]).css(a[1])}),define_libfunc("set-content!",2,2,function(a){assert_string(a[1]);var c=a[1].replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;");$(a[0]).html(c);return BiwaScheme.undef}),define_libfunc("get-content",1,1,function(a){return BiwaScheme.element_content(a[0])}),define_libfunc("set-handler!",3,3,
function(){throw Error("set-handler! is obsolete, please use add-handler! instead");}),define_libfunc("add-handler!",3,3,function(a,c){var d=a[0],e=a[1],f=a[2],g=new Interpreter(c),h=function(a){return _.clone(g).invoke_closure(f,[a])};$(d).bind(e,h);return h}),define_libfunc("remove-handler!",3,3,function(a){var c=a[1],d=a[2];$(a[0]).unbind(c,d);return BiwaScheme.undef}),define_libfunc("wait-for",2,2,function(a){var c=a[1],d=$(a[0]);d.biwascheme_wait_for=d.biwascheme_wait_for||{};(a=d.biwascheme_wait_for[c])&&
d.unbind(c,a);return new BiwaScheme.Pause(function(a){var f=function(){d.biwascheme_wait_for[c]=void 0;d.unbind(c,f);return a.resume(BiwaScheme.undef)};d.biwascheme_wait_for[c]=f;d.bind(c,f)})}),define_libfunc("domelem",1,null,function(){throw Error("obsolete");}),define_libfunc("dom-remove-children!",1,1,function(a){Console.puts("warning: dom-remove-children! is obsolete. use element-empty! instead");$(a[0]).empty();return BiwaScheme.undef}),define_libfunc("dom-create-element",1,1,function(){throw Error("obsolete");
}),define_libfunc("element-append-child!",2,2,function(a){return $(a[0]).append(a[1])}),define_libfunc("dom-remove-child!",2,2,function(){throw Error("obsolete");}),define_libfunc("http-request",1,1,function(a){var c=a[0];assert_string(c);return new BiwaScheme.Pause(function(a){$.get(c,function(c){a.resume(c)},"text")})}),define_libfunc("http-post",2,2,function(a){var c=a[0];assert_string(c);a=a[1];assert_list(a);var d=alist_to_js_obj(a);return new BiwaScheme.Pause(function(a){$.post(c,d,function(c){a.resume(c)},
"text")})}),BiwaScheme.jsonp_receiver=[],define_libfunc("receive-jsonp",1,1,function(a){var c=a[0];assert_string(c);for(var d=BiwaScheme.jsonp_receiver,a=0;a<d.length;a++)if(d[a]===null)break;var e=a;c+="?callback=BiwaScheme.jsonp_receiver["+e+"]";return new BiwaScheme.Pause(function(a){d[e]=function(c){a.resume(c);d[e]=null};var g=$("<script/>",{src:c});$("body").append(g)})}),define_libfunc("alert",1,1,function(a){alert(a[0]);return BiwaScheme.undef}),define_libfunc("confirm",1,1,function(a){return confirm(a[0])});
typeof BiwaScheme!="object"&&(BiwaScheme={});
with(BiwaScheme){define_libfunc("html-escape",1,1,function(a){assert_string(a[0]);return _.escape(a[0])});BiwaScheme.inspect_objs=function(a){return _.map(a,BiwaScheme.inspect).join(", ")};define_libfunc("inspect",1,null,function(a){return BiwaScheme.inspect_objs(a)});define_libfunc("inspect!",1,null,function(a){Console.puts(BiwaScheme.inspect_objs(a));return BiwaScheme.undef});BiwaScheme.json2sexp=function(a){switch(true){case _.isNumber(a)||_.isString(a)||a===true||a===false:return a;case _.isArray(a):return array_to_list(_.map(a,
json2sexp));case typeof a=="object":var c=nil;for(key in a)c=new Pair(new Pair(key,json2sexp(a[key])),c);return c;default:throw Error("json->sexp: detected invalid value for json: "+BiwaScheme.inspect(a));}throw new Bug("must not happen");};define_libfunc("json->sexp",1,1,function(a){return json2sexp(a[0])});define_libfunc("vector-push!",2,null,function(a){assert_vector(a[0]);for(var c=1;c<a.length;c++)a[0].push(a[c]);return a[0]});define_libfunc("identity",1,1,function(a){return a[0]});define_syntax("inc!",
function(a){a=a.cdr.car;return List(Sym("set!"),a,List(Sym("+"),a,1))});define_syntax("dec!",function(a){a=a.cdr.car;return List(Sym("set!"),a,List(Sym("-"),a,1))});define_libfunc("string-concat",1,1,function(a){assert_list(a[0]);return a[0].to_array().join("")});define_libfunc("string-split",2,2,function(a){assert_string(a[0]);assert_string(a[1]);return array_to_list(a[0].split(a[1]))});define_libfunc("string-join",1,2,function(a){assert_list(a[0]);var c="";a[1]&&(assert_string(a[1]),c=a[1]);return a[0].to_array().join(c)});
define_libfunc("intersperse",2,2,function(a){var c=a[0],a=a[1];assert_list(a);var d=[];_.each(a.to_array().reverse(),function(a){d.push(a);d.push(c)});d.pop();return array_to_list(d)});define_libfunc("map-with-index",2,null,function(a){var c=a.shift();_.each(a,assert_list);var d=[],e=0;return Call.multi_foreach(a,{call:function(a){a=_.map(a,function(a){return a.car});a.unshift(e);e++;return new Call(c,a)},result:function(a){d.push(a)},finish:function(){return array_to_list(d)}})});define_syntax("dotimes",
function(a){var c=a.cdr.car,a=a.cdr.cdr,d=c.car,e=c.cdr.car,c=c.cdr.cdr.car,f=BiwaScheme.gensym(),e=deep_array_to_list([[f,e],[d,0,[Sym("+"),d,1]]]),d=deep_array_to_list([[Sym(">="),d,f],c]);return new Pair(Sym("do"),new Pair(e,new Pair(d,a)))});var sort_with_comp=function(a,c,d){return a.sort(function(a,f){return(new BiwaScheme.Interpreter(d)).invoke_closure(c,[a,f])})};define_libfunc("list-sort/comp",1,2,function(a,c){assert_procedure(a[0]);assert_list(a[1]);return array_to_list(sort_with_comp(a[1].to_array(),
a[0],c))});define_libfunc("vector-sort/comp",1,2,function(a,c){assert_procedure(a[0]);assert_vector(a[1]);return sort_with_comp(_.clone(a[1]),a[0],c)});define_libfunc("vector-sort/comp!",1,2,function(a,c){assert_procedure(a[0]);assert_vector(a[1]);sort_with_comp(a[1],a[0],c);return BiwaScheme.undef});var rearrange_args=function(a,c){var d=[],e=(new Compiler).find_dot_pos(a);if(e==-1)d=c;else{for(var f=0;f<e;f++)d[f]=c[f];d[f]=array_to_list(c.slice(f))}return d};define_syntax("define-macro",function(a){var c=
a.cdr.car,d;if(c instanceof Pair){var e=c.car;d=c.cdr;a=a.cdr.cdr;a=new Pair(Sym("lambda"),new Pair(d,a))}else e=c,a=a.cdr.cdr.car,d=a.cdr.car;a=Compiler.compile(a);if(a[1]!=0)throw new Bug("you cannot use free variables in macro expander (or define-macro must be on toplevel)");var f=[a[2]];TopEnv[e.name]=new Syntax(e.name,function(a){var c=a.to_array();c.shift();a=new Interpreter;c=rearrange_args(d,c);return a.invoke_closure(f,c)});return BiwaScheme.undef});var macroexpand_1=function(a){if(a instanceof
Pair)if(a.car instanceof Symbol&&TopEnv[a.car.name]instanceof Syntax)a=TopEnv[a.car.name].transform(a);else throw Error("macroexpand-1: `"+to_write_ss(a)+"' is not a macro");return a};define_syntax("%macroexpand",function(a){a=BiwaScheme.Interpreter.expand(a.cdr.car);return List(Sym("quote"),a)});define_syntax("%macroexpand-1",function(a){a=macroexpand_1(a.cdr.car);return List(Sym("quote"),a)});define_libfunc("macroexpand",1,1,function(a){return BiwaScheme.Interpreter.expand(a[0])});define_libfunc("macroexpand-1",
1,1,function(a){return macroexpand_1(a[0])});define_libfunc("gensym",0,0,function(){return BiwaScheme.gensym()});define_libfunc("print",1,null,function(a){_.map(a,function(a){Console.puts(to_display(a),true)});Console.puts("");return BiwaScheme.undef});define_libfunc("write-to-string",1,1,function(a){return to_write(a[0])});define_libfunc("read-from-string",1,1,function(a){assert_string(a[0]);return Interpreter.read(a[0])});define_libfunc("port-closed?",1,1,function(a){assert_port(a[0]);return!a[0].is_open});
define_libfunc("with-output-to-port",2,2,function(a){var c=a[0],a=a[1];assert_port(c);assert_procedure(a);var d=BiwaScheme.Port.current_output;BiwaScheme.Port.current_output=c;return new Call(a,[c],function(a){c.close();BiwaScheme.Port.current_output=d;return a[0]})});define_syntax("let1",function(a){var c=a.cdr.car,d=a.cdr.cdr.car,a=a.cdr.cdr.cdr;return new Pair(new Pair(Sym("lambda"),new Pair(new Pair(c,nil),a)),new Pair(d,nil))});var assert_regexp=function(a,c){if(!(a instanceof RegExp))throw Error(c+
": regexp required, but got "+to_write(a));};define_libfunc("string->regexp",1,1,function(a){assert_string(a[0],"string->regexp");return RegExp(a[0])});define_libfunc("regexp?",1,1,function(a){return a[0]instanceof RegExp});define_libfunc("regexp->string",1,1,function(a){assert_regexp(a[0],"regexp->string");return a[0].toString().slice(1,-1)});define_libfunc("regexp-exec",2,2,function(a){var c=a[0];_.isString(a[0])&&(c=RegExp(a[0]));assert_regexp(c,"regexp-exec");assert_string(a[1],"regexp-exec");
a=c.exec(a[1]);return a===null?false:array_to_list(a)});define_libfunc("regexp-replace-all",3,3,function(a){var c=a[0];_.isString(c)?c=RegExp(c,"g"):(assert_regexp(c),c=RegExp(c.source,"g"));assert_string(a[1]);assert_string(a[2]);return a[1].replace(c,a[2])})}
(function(){var a,c;BiwaScheme.on_node&&(a=require("fs"),require("path"),c=process);var d=function(){var a=_.toArray(arguments);if(!BiwaScheme.on_node){var c=a[0];a.pop();a.push(function(){throw new BiwaScheme.Error("the function '"+c+"' is not supported in the browser (works only on Node.js).");})}BiwaScheme.define_libfunc.apply(null,a)};d("file-exists?",1,1,function(c){assert_string(c[0]);return a.existsSync(c[0])});d("delete-file",1,1,function(c){assert_string(c[0]);a.unlinkSync(c[0]);return BiwaScheme.undef});
d("command-line",0,0,function(){return BiwaScheme.List.apply(null,c.argv)});d("exit",0,1,function(a){a=a[0];a=_.isUndefined(a)?0:a===false?1:Number(a);c.exit(a)});d("get-environment-variable",1,1,function(a){assert_string(a[0]);a=c.env[a[0]];return _.isUndefined(a)?false:a});d("get-environment-variables",0,0,function(){return BiwaScheme.js_obj_to_alist(c.env)})})();
with(BiwaScheme){define_libfunc("iota",1,3,function(a){var c=a[0],d=a[1]||0,a=a[2]===void 0?1:a[2];assert_integer(c);assert_number(d);assert_number(a);for(var e=[],f=0;f<c;f++)e.push(d),d+=a;return array_to_list(e)});var copy_pair=function(a){var c=BiwaScheme.isPair(a.car)?copy_pair(a.car):a.car,a=BiwaScheme.isPair(a.cdr)?copy_pair(a.cdr):a.cdr;return new Pair(c,a)};define_libfunc("list-copy",1,1,function(a){return BiwaScheme.isPair(a[0])?copy_pair(a[0]):BiwaScheme.nil});define_libfunc("open-input-string",
1,1,function(a){assert_string(a[0]);return new Port.StringInput(a[0])});define_libfunc("open-output-string",0,0,function(){return new Port.StringOutput});define_libfunc("get-output-string",1,1,function(a){assert_port(a[0]);if(!(a[0]instanceof Port.StringOutput))throw Error("get-output-string: port must be made by 'open-output-string'");return a[0].output_string()});define_syntax("receive",function(a){assert(BiwaScheme.isPair(a.cdr),"missing formals","receive");var c=a.cdr.car;assert(BiwaScheme.isPair(a.cdr.cdr),
"missing expression","receive");var d=a.cdr.cdr.car,a=a.cdr.cdr.cdr;return deep_array_to_list([Sym("call-with-values"),[Sym("lambda"),BiwaScheme.nil,d],new BiwaScheme.Pair(Sym("lambda"),new BiwaScheme.Pair(c,a))])});define_libfunc("current-date",0,1,function(){return new Date});define_libfunc("date?",1,1,function(a){return a[0]instanceof Date});define_libfunc("date-nanosecond",1,1,function(a){assert_date(a[0]);return a[0].getMilliseconds()*1E6});define_libfunc("date-millisecond",1,1,function(a){assert_date(a[0]);
return a[0].getMilliseconds()});define_libfunc("date-second",1,1,function(a){assert_date(a[0]);return a[0].getSeconds()});define_libfunc("date-minute",1,1,function(a){assert_date(a[0]);return a[0].getMinutes()});define_libfunc("date-hour",1,1,function(a){assert_date(a[0]);return a[0].getHours()});define_libfunc("date-day",1,1,function(a){assert_date(a[0]);return a[0].getDate()});define_libfunc("date-month",1,1,function(a){assert_date(a[0]);return a[0].getMonth()+1});define_libfunc("date-year",1,1,
function(a){assert_date(a[0]);return a[0].getFullYear()});define_libfunc("date-week-day",1,1,function(a){assert_date(a[0]);return a[0].getDay()});BiwaScheme.date_names={weekday:"Sun,Mon,Tue,Wed,Thu,Fri,Sat".split(","),full_weekday:"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday".split(","),month:"Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec".split(","),full_month:"January,February,March,April,May,June,July,August,September,Octorber,November,December".split(",")};BiwaScheme.date2string=
function(a,c){var d=function(a){return a<10?"0"+a:""+a},e=function(a){return a<10?" "+a:""+a},f={a:function(a){return date_names.weekday[a.getDay()]},A:function(a){return date_names.full_weekday[a.getDay()]},b:function(a){return date_names.month[a.getMonth()]},B:function(a){return date_names.full_month[a.getMonth()]},c:function(a){return a.toString()},d:function(a){return d(a.getDate())},D:function(a){return f.d(a)+f.m(a)+f.y(a)},e:function(a){return e(a.getDate())},f:function(a){return a.getSeconds()+
a.getMilliseconds()/1E3},h:function(a){return date_names.month[a.getMonth()]},H:function(a){return d(a.getHours())},I:function(a){a=a.getHours();return d(a<13?a:a-12)},j:function(){throw new Bug("not implemented: day of year");},k:function(a){return e(a.getHours())},l:function(a){a=a.getHours();return e(a<13?a:a-12)},m:function(a){return d(a.getMonth())},M:function(a){return d(a.getMinutes())},n:function(){return"\n"},N:function(){throw new Bug("not implemented: nanoseconds");},p:function(a){return a.getHours()<
13?"AM":"PM"},r:function(a){return f.I(a)+":"+f.M(a)+":"+f.S(a)+" "+f.p(a)},s:function(a){return Math.floor(a.getTime()/1E3)},S:function(a){return d(a.getSeconds())},t:function(){return"\t"},T:function(a){return f.H(a)+":"+f.M(a)+":"+f.S(a)},U:function(){throw new Bug("not implemented: weeknum(0~, Sun)");},V:function(){throw new Bug("not implemented: weeknum(1~, Sun?)");},w:function(a){return a.getDay()},W:function(){throw new Bug("not implemented: weeknum(0~, Mon)");},x:function(){throw new Bug("not implemented: weeknum(1~, Mon)");
},X:function(a){return f.Y(a)+"/"+f.m(a)+"/"+f.d(a)},y:function(a){return a.getFullYear()%100},Y:function(a){return a.getFullYear()},z:function(){throw new Bug("not implemented: time-zone");},Z:function(){throw new Bug("not implemented: symbol time zone");},1:function(){throw new Bug("not implemented: ISO-8601 year-month-day format");},2:function(){throw new Bug("not implemented: ISO-8601 hour-minute-second-timezone format");},3:function(){throw new Bug("not implemented: ISO-8601 hour-minute-second format");
},4:function(){throw new Bug("not implemented: ISO-8601 year-month-day-hour-minute-second-timezone format");},5:function(){throw new Bug("not implemented: ISO-8601 year-month-day-hour-minute-second format");}};return c.replace(/~([\w1-5~])/g,function(c,d){var e=f[d];return e?e(a):d=="~"?"~":d})};define_libfunc("date->string",1,2,function(a){assert_date(a[0]);return a[1]?(assert_string(a[1]),date2string(a[0],a[1])):a[0].toString()});define_libfunc("parse-date",1,1,function(a){assert_string(a[0]);return new Date(Date.parse(a[0]))});
define_libfunc("random-integer",1,1,function(a){var c=a[0];assert_integer(c);if(c<0)throw Error("random-integer: the argument must be >= 0");else return Math.floor(Math.random()*a[0])});define_libfunc("random-real",0,0,function(){return Math.random()});define_libfunc("format",1,null,function(a){if(_.isString(a[0]))var c=null,d=a.shift();else a[0]===false?(a.shift(),c=null,d=a.shift()):a[0]===true?(a.shift(),c=BiwaScheme.Port.current_output,d=a.shift()):(c=a.shift(),d=a.shift(),assert_port(c));d=d.replace(/~[as]/g,
function(c){assert(a.length>0,"insufficient number of arguments","format");return c=="~a"?BiwaScheme.to_display(a.shift()):BiwaScheme.to_write(a.shift())}).replace(/~%/,"\n").replace(/~~/,"~");return c?(c.put_string(d),BiwaScheme.undef):d});var user_write_ss=function(a){Console.puts(write_ss(a[0]),true);return BiwaScheme.undef};define_libfunc("write/ss",1,2,user_write_ss);define_libfunc("write-with-shared-structure",1,2,user_write_ss);define_libfunc("write*",1,2,user_write_ss);define_libfunc("vector-append",
2,null,function(a){var c=[];return c.concat.apply(c,a)});define_libfunc("vector-copy",1,1,function(a){assert_vector(a[0]);return _.clone(a[0])})}
with(BiwaScheme)BiwaScheme.Dumper=BiwaScheme.Class.create({initialize:function(a){this.dumparea=a||$("#dumparea")[0]||null;this.reset()},reset:function(){this.dumparea&&$(this.dumparea).empty();this.n_folds=0;this.closures=[];this.n_dumps=0;this.cur=-1;this.is_folded=true},is_opc:function(a){return a instanceof Array&&typeof a[0]=="string"},dump_pad:"&nbsp;&nbsp;&nbsp;",dump_opc:function(a,c,d){var e="",f="",g="",c=c||0,d=d||false;_.times(c,_.bind(function(){f+=this.dump_pad},this));_.times(c+1,_.bind(function(){g+=
this.dump_pad},this));e+=f+'[<span class="dump_opecode">'+a[0]+"</span>";for(var h=1;!(a[h]instanceof Array)&&h<a.length;)e+=a[0]=="constant"?"&nbsp;<span class='dump_constant'>"+this.dump_obj(a[h])+"</span>":"&nbsp;"+this.dump_obj(a[h]),h++;for(h<a.length&&(e+="<br>\n");h<a.length;h++)this.is_opc(a[h])?e+=this.dump_opc(a[h],h==a.length-1?c:c+1,true):(e+=h==a.length-1?f:g,e+=this.dump_obj(a[h])),h!=a.length-1&&(e+="<br>\n");e+="]";return d?e:this.add_fold(e)},fold_limit:20,add_fold:function(a){var c=
a.split(/<br>/gmi);if(c.length>this.fold_limit){var a=" <span style='text-decoration:underline; color:blue; cursor:pointer;'onclick='BiwaScheme.Dumper.toggle_fold("+this.n_folds+")'>more</span>",d="<div style='display:none' class='fold"+this.n_folds+"'>";this.n_folds++;return[c.slice(0,this.fold_limit).join("<br>"),a,d,c.slice(this.fold_limit).join("<br>"),"</div>"].join("")}else return a},stack_max_len:80,dump_stack:function(a,c){if(a===null||a===void 0)return BiwaScheme.inspect(a);var d="<table>";
if(a.length==0)d+="<tr><td class='dump_dead'>(stack is empty)</td></tr>";else if(c<a.length){var e=a.length-1;d+="<tr><td class='dump_dead'>["+e+"]</td><td class='dump_dead'>"+_.str.truncate(this.dump_obj(a[e]),this.stack_max_len)+"</td></tr>"}for(e=c-1;e>=0;e--)d+="<tr><td class='dump_stknum'>["+e+"]</td><td>"+_.str.truncate(this.dump_obj(a[e]),this.stack_max_len)+"</td></tr>";return d+"</table>"},dump_object:function(a){var c=[],d;for(d in a)c.push(d.toString());return"#<Object{"+c.join(",")+"}>"},
dump_closure:function(a){if(a.length==0)return"[]";for(var c=null,d=0;d<this.closures.length;d++)this.closures[d]==a&&(c=d);if(c==null)c=this.closures.length,this.closures.push(a);a=_.clone(a);d=a.shift();return["c",c," <span class='dump_closure'>free vars :</span> ",this.dump_obj(a)," <span class='dump_closure'>body :</span> ",_.str.truncate(this.dump_obj(d),100)].join("")},dump_obj:function(a){if(a&&typeof a.to_html=="function")return a.to_html();else{var c=write_ss(a,true);c=="[object Object]"&&
(c=this.dump_object(a));return _.escape(c)}},dump:function(a){var c="";a instanceof Object?(c+="<table>",c+="<tr><td colspan='4'><a href='#' class='header'>#"+this.n_dumps+"</a></td></tr>",_.each(_.keys(a),_.bind(function(d){var f=a[d];d!="x"&&d!="stack"&&(f=d=="c"?this.dump_closure(f):this.dump_obj(f),c+="<tr><td>"+d+": </td><td colspan='3'>"+f+"</td></tr>")},this)),c+="<tr><td>x:</td><td>"+(this.is_opc(a.x)?this.dump_opc(a.x):this.dump_obj(a.x))+"</td>",c+="<td style='border-left: 1px solid black'>stack:</td><td>"+
this.dump_stack(a.stack,a.s)+"</td></tr>",c+="</table>"):c=_.escape(BiwaScheme.inspect(a))+"<br>\n";var d=$("<div/>",{"class":"dump"+this.n_dumps});d.html(c);$(this.dumparea).append(d);_.bind(function(a){$(".header",this.dump_el(this.n_dumps)).click(_.bind(function(){this.dump_move_to(a);this.dump_fold()},this))},this)(this.n_dumps);d.hide();this.n_dumps++},dump_el:function(a){return $(".dump"+a,this.dumparea)},dump_move_to:function(a){if(0<=a&&a<=this.n_dumps)this.dump_el(this.cur).hide(),this.cur=
a,this.dump_el(this.cur).show()},dump_move:function(a){0<=this.cur&&this.cur<this.n_dumps&&this.dump_el(this.cur).hide();0<=this.cur+a&&this.cur+a<this.n_dumps&&(this.cur+=a);this.dump_el(this.cur).show()},dump_fold:function(){for(var a=0;a<this.n_dumps;a++)a!=this.cur&&this.dump_el(a).hide();this.is_folded=true},dump_unfold:function(){for(var a=0;a<this.n_dumps;a++)this.dump_el(a).show();this.is_folded=false},dump_toggle_fold:function(){this.is_folded?this.dump_unfold():this.dump_fold()}});
BiwaScheme.Dumper.toggle_fold=function(a){$(".fold"+a,this.dumparea).toggle()};Console={};BiwaScheme.Port.current_error=BiwaScheme.Port.current_output=new BiwaScheme.Port.CustomOutput(function(a){var c;c=$("#bs-console");if(c[0]){var a=_.escape(a),d=$("<span>");d.html(a.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;"));c.append(d)}});
BiwaScheme.Port.current_input=new BiwaScheme.Port.CustomInput(function(a){var c=$("<form/>");c.html("<input id='webscheme-read-line' type='text'><input type='submit' value='ok'>");$("#bs-console").append(c);c.submit(function(){var d=$("#webscheme-read-line").val();c.remove();a(d);return false})});Console.puts=function(a,c){BiwaScheme.Port.current_output.put_string(a+(c?"":"\n"))};Console.p=function(){BiwaScheme.Port.current_output.put_string("p> "+_.map(_.toArray(arguments),BiwaScheme.inspect).join(" "))};
